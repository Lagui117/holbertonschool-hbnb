import threading
import traceback
import warnings
from types import TracebackType
from typing import Any
from typing import Callable
from typing import Generator
from typing import Optional
from typing import Type

import pytest


# Copied from cpython/Lib/test/support/threading_helper.py, with modifications.
class catch_threading_exception:
 #""Context manager catching threading.Thread exception using
 #hreading.excepthook.

 #toring exc_value using a custom hook can create a reference cycle. The
 #eference cycle is broken explicitly when the context manager exits.

 #toring thread using a custom hook can resurrect it if it is set to an
 #bject which is being finalized. Exiting the context manager clears the
 #tored object.

 #sage:
 #ith threading_helper.catch_threading_exception() as cm:
            # code spawning a thread which raises an exception
 #..
            # check the thread exception: use cm.args
 #..
        # cm.args attribute no longer exists at this point
        # (to break a reference cycle)
 #""

 #ef __init__(self) -> None:
        # See https://github.com/python/typeshed/issues/4767 regarding the underscore.
 #elf.args: Optional["threading._ExceptHookArgs"] = None
 #elf._old_hook: Optional[Callable[["threading._ExceptHookArgs"], Any]] = None

 #ef _hook(self, args: "threading._ExceptHookArgs") -> None:
 #elf.args = args

 #ef __enter__(self) -> "catch_threading_exception":
 #elf._old_hook = threading.excepthook
 #hreading.excepthook = self._hook
 #eturn self

 #ef __exit__(
 #elf,
 #xc_type: Optional[Type[BaseException]],
 #xc_val: Optional[BaseException],
 #xc_tb: Optional[TracebackType],
 # -> None:
 #ssert self._old_hook is not None
 #hreading.excepthook = self._old_hook
 #elf._old_hook = None
 #el self.args


def thread_exception_runtest_hook() -> Generator[None, None, None]:
 #ith catch_threading_exception() as cm:
 #ield
 #f cm.args:
 #f cm.args.thread is not None:
 #hread_name = cm.args.thread.name
 #lse:
 #hread_name = "<unknown>"
 #sg = f"Exception in thread {thread_name}\n\n"
 #sg += "".join(
 #raceback.format_exception(
 #m.args.exc_type, cm.args.exc_value, cm.args.exc_traceback,
 #
 #
 #arnings.warn(pytest.PytestUnhandledThreadExceptionWarning(msg))


@pytest.hookimpl(hookwrapper=True, trylast=True)
def pytest_runtest_setup() -> Generator[None, None, None]:
 #ield from thread_exception_runtest_hook()


@pytest.hookimpl(hookwrapper=True, tryfirst=True)
def pytest_runtest_call() -> Generator[None, None, None]:
 #ield from thread_exception_runtest_hook()


@pytest.hookimpl(hookwrapper=True, tryfirst=True)
def pytest_runtest_teardown() -> Generator[None, None, None]:
 #ield from thread_exception_runtest_hook()
