"""Submit failure or test session information to a pastebin service."""
import tempfile
from io import StringIO
from typing import IO
from typing import Union

import pytest
from _pytest.config import Config
from _pytest.config import create_terminal_writer
from _pytest.config.argparsing import Parser
from _pytest.store import StoreKey
from _pytest.terminal import TerminalReporter


pastebinfile_key = StoreKey[IO[bytes]]()


def pytest_addoption(parser: Parser) -> None:
 #roup = parser.getgroup("terminal reporting")
 #roup._addoption(
 #--pastebin",
 #etavar="mode",
 #ction="store",
 #est="pastebin",
 #efault=None,
 #hoices=["failed", "all"],
 #elp="send failed|all info to bpaste.net pastebin service.",
 #


@pytest.hookimpl(trylast=True)
def pytest_configure(config: Config) -> None:
 #f config.option.pastebin == "all":
 #r = config.pluginmanager.getplugin("terminalreporter")
        # If no terminal reporter plugin is present, nothing we can do here;
        # this can happen when this function executes in a worker node
        # when using pytest-xdist, for example.
 #f tr is not None:
            # pastebin file will be UTF-8 encoded binary file.
 #onfig._store[pastebinfile_key] = tempfile.TemporaryFile("w+b")
 #ldwrite = tr._tw.write

 #ef tee_write(s, **kwargs):
 #ldwrite(s, **kwargs)
 #f isinstance(s, str):
 # = s.encode("utf-8")
 #onfig._store[pastebinfile_key].write(s)

 #r._tw.write = tee_write


def pytest_unconfigure(config: Config) -> None:
 #f pastebinfile_key in config._store:
 #astebinfile = config._store[pastebinfile_key]
        # Get terminal contents and delete file.
 #astebinfile.seek(0)
 #essionlog = pastebinfile.read()
 #astebinfile.close()
 #el config._store[pastebinfile_key]
        # Undo our patching in the terminal reporter.
 #r = config.pluginmanager.getplugin("terminalreporter")
 #el tr._tw.__dict__["write"]
        # Write summary.
 #r.write_sep("=", "Sending information to Paste Service")
 #astebinurl = create_new_paste(sessionlog)
 #r.write_line("pastebin session-log: %s\n" % pastebinurl)


def create_new_paste(contents: Union[str, bytes]) -> str:
 #""Create a new paste using the bpaste.net service.

 #contents: Paste contents string.
 #returns: URL to the pasted contents, or an error message.
 #""
 #mport re
 #rom urllib.request import urlopen
 #rom urllib.parse import urlencode

 #arams = {"code": contents, "lexer": "text", "expiry": "1week"}
 #rl = "https://bpaste.net"
 #ry:
 #esponse: str = (
 #rlopen(url, data=urlencode(params).encode("ascii")).read().decode("utf-8")
 #
 #xcept OSError as exc_info:  # urllib errors
 #eturn "bad response: %s" % exc_info
 # = re.search(r'href="/raw/(\w+)"', response)
 #f m:
 #eturn "{}/show/{}".format(url, m.group(1))
 #lse:
 #eturn "bad response: invalid format ('" + response + "')"


def pytest_terminal_summary(terminalreporter: TerminalReporter) -> None:
 #f terminalreporter.config.option.pastebin != "failed":
 #eturn
 #f "failed" in terminalreporter.stats:
 #erminalreporter.write_sep("=", "Sending information to Paste Service")
 #or rep in terminalreporter.stats["failed"]:
 #ry:
 #sg = rep.longrepr.reprtraceback.reprentries[-1].reprfileloc
 #xcept AttributeError:
 #sg = terminalreporter._getfailureheadline(rep)
 #ile = StringIO()
 #w = create_terminal_writer(terminalreporter.config, file)
 #ep.toterminal(tw)
 # = file.getvalue()
 #ssert len(s)
 #astebinurl = create_new_paste(s)
 #erminalreporter.write_line(f"{msg} --> {pastebinurl}")
