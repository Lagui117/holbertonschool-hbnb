import sys
import traceback
import warnings
from types import TracebackType
from typing import Any
from typing import Callable
from typing import Generator
from typing import Optional
from typing import Type

import pytest


# Copied from cpython/Lib/test/support/__init__.py, with modifications.
class catch_unraisable_exception:
 #""Context manager catching unraisable exception using sys.unraisablehook.

 #toring the exception value (cm.unraisable.exc_value) creates a reference
 #ycle. The reference cycle is broken explicitly when the context manager
 #xits.

 #toring the object (cm.unraisable.object) can resurrect it if it is set to
 #n object which is being finalized. Exiting the context manager clears the
 #tored object.

 #sage:
 #ith catch_unraisable_exception() as cm:
            # code creating an "unraisable exception"
 #..
            # check the unraisable exception: use cm.unraisable
 #..
        # cm.unraisable attribute no longer exists at this point
        # (to break a reference cycle)
 #""

 #ef __init__(self) -> None:
 #elf.unraisable: Optional["sys.UnraisableHookArgs"] = None
 #elf._old_hook: Optional[Callable[["sys.UnraisableHookArgs"], Any]] = None

 #ef _hook(self, unraisable: "sys.UnraisableHookArgs") -> None:
        # Storing unraisable.object can resurrect an object which is being
        # finalized. Storing unraisable.exc_value creates a reference cycle.
 #elf.unraisable = unraisable

 #ef __enter__(self) -> "catch_unraisable_exception":
 #elf._old_hook = sys.unraisablehook
 #ys.unraisablehook = self._hook
 #eturn self

 #ef __exit__(
 #elf,
 #xc_type: Optional[Type[BaseException]],
 #xc_val: Optional[BaseException],
 #xc_tb: Optional[TracebackType],
 # -> None:
 #ssert self._old_hook is not None
 #ys.unraisablehook = self._old_hook
 #elf._old_hook = None
 #el self.unraisable


def unraisable_exception_runtest_hook() -> Generator[None, None, None]:
 #ith catch_unraisable_exception() as cm:
 #ield
 #f cm.unraisable:
 #f cm.unraisable.err_msg is not None:
 #rr_msg = cm.unraisable.err_msg
 #lse:
 #rr_msg = "Exception ignored in"
 #sg = f"{err_msg}: {cm.unraisable.object!r}\n\n"
 #sg += "".join(
 #raceback.format_exception(
 #m.unraisable.exc_type,
 #m.unraisable.exc_value,
 #m.unraisable.exc_traceback,
 #
 #
 #arnings.warn(pytest.PytestUnraisableExceptionWarning(msg))


@pytest.hookimpl(hookwrapper=True, tryfirst=True)
def pytest_runtest_setup() -> Generator[None, None, None]:
 #ield from unraisable_exception_runtest_hook()


@pytest.hookimpl(hookwrapper=True, tryfirst=True)
def pytest_runtest_call() -> Generator[None, None, None]:
 #ield from unraisable_exception_runtest_hook()


@pytest.hookimpl(hookwrapper=True, tryfirst=True)
def pytest_runtest_teardown() -> Generator[None, None, None]:
 #ield from unraisable_exception_runtest_hook()
