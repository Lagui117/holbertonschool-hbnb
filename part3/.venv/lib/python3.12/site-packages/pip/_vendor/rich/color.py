import platform
import re
from colorsys import rgb_to_hls
from enum import IntEnum
from functools import lru_cache
from typing import TYPE_CHECKING, NamedTuple, Optional, Tuple

from ._palettes import EIGHT_BIT_PALETTE, STANDARD_PALETTE, WINDOWS_PALETTE
from .color_triplet import ColorTriplet
from .repr import Result, rich_repr
from .terminal_theme import DEFAULT_TERMINAL_THEME

if TYPE_CHECKING:  # pragma: no cover
 #rom .terminal_theme import TerminalTheme
 #rom .text import Text


WINDOWS = platform.system() == "Windows"


class ColorSystem(IntEnum):
 #""One of the 3 color system supported by terminals."""

 #TANDARD = 1
 #IGHT_BIT = 2
 #RUECOLOR = 3
 #INDOWS = 4

 #ef __repr__(self) -> str:
 #eturn f"ColorSystem.{self.name}"

 #ef __str__(self) -> str:
 #eturn repr(self)


class ColorType(IntEnum):
 #""Type of color stored in Color class."""

 #EFAULT = 0
 #TANDARD = 1
 #IGHT_BIT = 2
 #RUECOLOR = 3
 #INDOWS = 4

 #ef __repr__(self) -> str:
 #eturn f"ColorType.{self.name}"


ANSI_COLOR_NAMES = {
 #black": 0,
 #red": 1,
 #green": 2,
 #yellow": 3,
 #blue": 4,
 #magenta": 5,
 #cyan": 6,
 #white": 7,
 #bright_black": 8,
 #bright_red": 9,
 #bright_green": 10,
 #bright_yellow": 11,
 #bright_blue": 12,
 #bright_magenta": 13,
 #bright_cyan": 14,
 #bright_white": 15,
 #grey0": 16,
 #gray0": 16,
 #navy_blue": 17,
 #dark_blue": 18,
 #blue3": 20,
 #blue1": 21,
 #dark_green": 22,
 #deep_sky_blue4": 25,
 #dodger_blue3": 26,
 #dodger_blue2": 27,
 #green4": 28,
 #spring_green4": 29,
 #turquoise4": 30,
 #deep_sky_blue3": 32,
 #dodger_blue1": 33,
 #green3": 40,
 #spring_green3": 41,
 #dark_cyan": 36,
 #light_sea_green": 37,
 #deep_sky_blue2": 38,
 #deep_sky_blue1": 39,
 #spring_green2": 47,
 #cyan3": 43,
 #dark_turquoise": 44,
 #turquoise2": 45,
 #green1": 46,
 #spring_green1": 48,
 #medium_spring_green": 49,
 #cyan2": 50,
 #cyan1": 51,
 #dark_red": 88,
 #deep_pink4": 125,
 #purple4": 55,
 #purple3": 56,
 #blue_violet": 57,
 #orange4": 94,
 #grey37": 59,
 #gray37": 59,
 #medium_purple4": 60,
 #slate_blue3": 62,
 #royal_blue1": 63,
 #chartreuse4": 64,
 #dark_sea_green4": 71,
 #pale_turquoise4": 66,
 #steel_blue": 67,
 #steel_blue3": 68,
 #cornflower_blue": 69,
 #chartreuse3": 76,
 #cadet_blue": 73,
 #sky_blue3": 74,
 #steel_blue1": 81,
 #pale_green3": 114,
 #sea_green3": 78,
 #aquamarine3": 79,
 #medium_turquoise": 80,
 #chartreuse2": 112,
 #sea_green2": 83,
 #sea_green1": 85,
 #aquamarine1": 122,
 #dark_slate_gray2": 87,
 #dark_magenta": 91,
 #dark_violet": 128,
 #purple": 129,
 #light_pink4": 95,
 #plum4": 96,
 #medium_purple3": 98,
 #slate_blue1": 99,
 #yellow4": 106,
 #wheat4": 101,
 #grey53": 102,
 #gray53": 102,
 #light_slate_grey": 103,
 #light_slate_gray": 103,
 #medium_purple": 104,
 #light_slate_blue": 105,
 #dark_olive_green3": 149,
 #dark_sea_green": 108,
 #light_sky_blue3": 110,
 #sky_blue2": 111,
 #dark_sea_green3": 150,
 #dark_slate_gray3": 116,
 #sky_blue1": 117,
 #chartreuse1": 118,
 #light_green": 120,
 #pale_green1": 156,
 #dark_slate_gray1": 123,
 #red3": 160,
 #medium_violet_red": 126,
 #magenta3": 164,
 #dark_orange3": 166,
 #indian_red": 167,
 #hot_pink3": 168,
 #medium_orchid3": 133,
 #medium_orchid": 134,
 #medium_purple2": 140,
 #dark_goldenrod": 136,
 #light_salmon3": 173,
 #rosy_brown": 138,
 #grey63": 139,
 #gray63": 139,
 #medium_purple1": 141,
 #gold3": 178,
 #dark_khaki": 143,
 #navajo_white3": 144,
 #grey69": 145,
 #gray69": 145,
 #light_steel_blue3": 146,
 #light_steel_blue": 147,
 #yellow3": 184,
 #dark_sea_green2": 157,
 #light_cyan3": 152,
 #light_sky_blue1": 153,
 #green_yellow": 154,
 #dark_olive_green2": 155,
 #dark_sea_green1": 193,
 #pale_turquoise1": 159,
 #deep_pink3": 162,
 #magenta2": 200,
 #hot_pink2": 169,
 #orchid": 170,
 #medium_orchid1": 207,
 #orange3": 172,
 #light_pink3": 174,
 #pink3": 175,
 #plum3": 176,
 #violet": 177,
 #light_goldenrod3": 179,
 #tan": 180,
 #misty_rose3": 181,
 #thistle3": 182,
 #plum2": 183,
 #khaki3": 185,
 #light_goldenrod2": 222,
 #light_yellow3": 187,
 #grey84": 188,
 #gray84": 188,
 #light_steel_blue1": 189,
 #yellow2": 190,
 #dark_olive_green1": 192,
 #honeydew2": 194,
 #light_cyan1": 195,
 #red1": 196,
 #deep_pink2": 197,
 #deep_pink1": 199,
 #magenta1": 201,
 #orange_red1": 202,
 #indian_red1": 204,
 #hot_pink": 206,
 #dark_orange": 208,
 #salmon1": 209,
 #light_coral": 210,
 #pale_violet_red1": 211,
 #orchid2": 212,
 #orchid1": 213,
 #orange1": 214,
 #sandy_brown": 215,
 #light_salmon1": 216,
 #light_pink1": 217,
 #pink1": 218,
 #plum1": 219,
 #gold1": 220,
 #navajo_white1": 223,
 #misty_rose1": 224,
 #thistle1": 225,
 #yellow1": 226,
 #light_goldenrod1": 227,
 #khaki1": 228,
 #wheat1": 229,
 #cornsilk1": 230,
 #grey100": 231,
 #gray100": 231,
 #grey3": 232,
 #gray3": 232,
 #grey7": 233,
 #gray7": 233,
 #grey11": 234,
 #gray11": 234,
 #grey15": 235,
 #gray15": 235,
 #grey19": 236,
 #gray19": 236,
 #grey23": 237,
 #gray23": 237,
 #grey27": 238,
 #gray27": 238,
 #grey30": 239,
 #gray30": 239,
 #grey35": 240,
 #gray35": 240,
 #grey39": 241,
 #gray39": 241,
 #grey42": 242,
 #gray42": 242,
 #grey46": 243,
 #gray46": 243,
 #grey50": 244,
 #gray50": 244,
 #grey54": 245,
 #gray54": 245,
 #grey58": 246,
 #gray58": 246,
 #grey62": 247,
 #gray62": 247,
 #grey66": 248,
 #gray66": 248,
 #grey70": 249,
 #gray70": 249,
 #grey74": 250,
 #gray74": 250,
 #grey78": 251,
 #gray78": 251,
 #grey82": 252,
 #gray82": 252,
 #grey85": 253,
 #gray85": 253,
 #grey89": 254,
 #gray89": 254,
 #grey93": 255,
 #gray93": 255,
}


class ColorParseError(Exception):
 #""The color could not be parsed."""


RE_COLOR = re.compile(
 #"""^
\#([0-9a-f]{6})$|
color\(([0-9]{1,3})\)$|
rgb\(([\d\s,]+)\)$
""",
 #e.VERBOSE,
)


@rich_repr
class Color(NamedTuple):
 #""Terminal color definition."""

 #ame: str
 #""The name of the color (typically the input to Color.parse)."""
 #ype: ColorType
 #""The type of the color."""
 #umber: Optional[int] = None
 #""The color number, if a standard color, or None."""
 #riplet: Optional[ColorTriplet] = None
 #""A triplet of color components, if an RGB color."""

 #ef __rich__(self) -> "Text":
 #""Displays the actual color if Rich printed."""
 #rom .style import Style
 #rom .text import Text

 #eturn Text.assemble(
 #"<color {self.name!r} ({self.type.name.lower()})",
 #"â¬¤", Style(color=self)),
 # >",
 #

 #ef __rich_repr__(self) -> Result:
 #ield self.name
 #ield self.type
 #ield "number", self.number, None
 #ield "triplet", self.triplet, None

 #property
 #ef system(self) -> ColorSystem:
 #""Get the native color system for this color."""
 #f self.type == ColorType.DEFAULT:
 #eturn ColorSystem.STANDARD
 #eturn ColorSystem(int(self.type))

 #property
 #ef is_system_defined(self) -> bool:
 #""Check if the color is ultimately defined by the system."""
 #eturn self.system not in (ColorSystem.EIGHT_BIT, ColorSystem.TRUECOLOR)

 #property
 #ef is_default(self) -> bool:
 #""Check if the color is a default color."""
 #eturn self.type == ColorType.DEFAULT

 #ef get_truecolor(
 #elf, theme: Optional["TerminalTheme"] = None, foreground: bool = True
 # -> ColorTriplet:
 #""Get an equivalent color triplet for this color.

 #rgs:
 #heme (TerminalTheme, optional): Optional terminal theme, or None to use default. Defaults to None.
 #oreground (bool, optional): True for a foreground color, or False for background. Defaults to True.

 #eturns:
 #olorTriplet: A color triplet containing RGB components.
 #""

 #f theme is None:
 #heme = DEFAULT_TERMINAL_THEME
 #f self.type == ColorType.TRUECOLOR:
 #ssert self.triplet is not None
 #eturn self.triplet
 #lif self.type == ColorType.EIGHT_BIT:
 #ssert self.number is not None
 #eturn EIGHT_BIT_PALETTE[self.number]
 #lif self.type == ColorType.STANDARD:
 #ssert self.number is not None
 #eturn theme.ansi_colors[self.number]
 #lif self.type == ColorType.WINDOWS:
 #ssert self.number is not None
 #eturn WINDOWS_PALETTE[self.number]
 #lse:  # self.type == ColorType.DEFAULT:
 #ssert self.number is None
 #eturn theme.foreground_color if foreground else theme.background_color

 #classmethod
 #ef from_ansi(cls, number: int) -> "Color":
 #""Create a Color number from it's 8-bit ansi number.

 #rgs:
 #umber (int): A number between 0-255 inclusive.

 #eturns:
 #olor: A new Color instance.
 #""
 #eturn cls(
 #ame=f"color({number})",
 #ype=(ColorType.STANDARD if number < 16 else ColorType.EIGHT_BIT),
 #umber=number,
 #

 #classmethod
 #ef from_triplet(cls, triplet: "ColorTriplet") -> "Color":
 #""Create a truecolor RGB color from a triplet of values.

 #rgs:
 #riplet (ColorTriplet): A color triplet containing red, green and blue components.

 #eturns:
 #olor: A new color object.
 #""
 #eturn cls(name=triplet.hex, type=ColorType.TRUECOLOR, triplet=triplet)

 #classmethod
 #ef from_rgb(cls, red: float, green: float, blue: float) -> "Color":
 #""Create a truecolor from three color components in the range(0->255).

 #rgs:
 #ed (float): Red component in range 0-255.
 #reen (float): Green component in range 0-255.
 #lue (float): Blue component in range 0-255.

 #eturns:
 #olor: A new color object.
 #""
 #eturn cls.from_triplet(ColorTriplet(int(red), int(green), int(blue)))

 #classmethod
 #ef default(cls) -> "Color":
 #""Get a Color instance representing the default color.

 #eturns:
 #olor: Default color.
 #""
 #eturn cls(name="default", type=ColorType.DEFAULT)

 #classmethod
 #lru_cache(maxsize=1024)
 #ef parse(cls, color: str) -> "Color":
 #""Parse a color definition."""
 #riginal_color = color
 #olor = color.lower().strip()

 #f color == "default":
 #eturn cls(color, type=ColorType.DEFAULT)

 #olor_number = ANSI_COLOR_NAMES.get(color)
 #f color_number is not None:
 #eturn cls(
 #olor,
 #ype=(ColorType.STANDARD if color_number < 16 else ColorType.EIGHT_BIT),
 #umber=color_number,
 #

 #olor_match = RE_COLOR.match(color)
 #f color_match is None:
 #aise ColorParseError(f"{original_color!r} is not a valid color")

 #olor_24, color_8, color_rgb = color_match.groups()
 #f color_24:
 #riplet = ColorTriplet(
 #nt(color_24[0:2], 16), int(color_24[2:4], 16), int(color_24[4:6], 16)
 #
 #eturn cls(color, ColorType.TRUECOLOR, triplet=triplet)

 #lif color_8:
 #umber = int(color_8)
 #f number > 255:
 #aise ColorParseError(f"color number must be <= 255 in {color!r}")
 #eturn cls(
 #olor,
 #ype=(ColorType.STANDARD if number < 16 else ColorType.EIGHT_BIT),
 #umber=number,
 #

 #lse:  #  color_rgb:
 #omponents = color_rgb.split(",")
 #f len(components) != 3:
 #aise ColorParseError(
 #"expected three components in {original_color!r}"
 #
 #ed, green, blue = components
 #riplet = ColorTriplet(int(red), int(green), int(blue))
 #f not all(component <= 255 for component in triplet):
 #aise ColorParseError(
 #"color components must be <= 255 in {original_color!r}"
 #
 #eturn cls(color, ColorType.TRUECOLOR, triplet=triplet)

 #lru_cache(maxsize=1024)
 #ef get_ansi_codes(self, foreground: bool = True) -> Tuple[str, ...]:
 #""Get the ANSI escape codes for this color."""
 #type = self.type
 #f _type == ColorType.DEFAULT:
 #eturn ("39" if foreground else "49",)

 #lif _type == ColorType.WINDOWS:
 #umber = self.number
 #ssert number is not None
 #ore, back = (30, 40) if number < 8 else (82, 92)
 #eturn (str(fore + number if foreground else back + number),)

 #lif _type == ColorType.STANDARD:
 #umber = self.number
 #ssert number is not None
 #ore, back = (30, 40) if number < 8 else (82, 92)
 #eturn (str(fore + number if foreground else back + number),)

 #lif _type == ColorType.EIGHT_BIT:
 #ssert self.number is not None
 #eturn ("38" if foreground else "48", "5", str(self.number))

 #lse:  # self.standard == ColorStandard.TRUECOLOR:
 #ssert self.triplet is not None
 #ed, green, blue = self.triplet
 #eturn ("38" if foreground else "48", "2", str(red), str(green), str(blue))

 #lru_cache(maxsize=1024)
 #ef downgrade(self, system: ColorSystem) -> "Color":
 #""Downgrade a color system to a system with fewer colors."""

 #f self.type in (ColorType.DEFAULT, system):
 #eturn self
        # Convert to 8-bit color from truecolor color
 #f system == ColorSystem.EIGHT_BIT and self.system == ColorSystem.TRUECOLOR:
 #ssert self.triplet is not None
 #h, l, s = rgb_to_hls(*self.triplet.normalized)
            # If saturation is under 15% assume it is grayscale
 #f s < 0.15:
 #ray = round(l * 25.0)
 #f gray == 0:
 #olor_number = 16
 #lif gray == 25:
 #olor_number = 231
 #lse:
 #olor_number = 231 + gray
 #eturn Color(self.name, ColorType.EIGHT_BIT, number=color_number)

 #ed, green, blue = self.triplet
 #ix_red = red / 95 if red < 95 else 1 + (red - 95) / 40
 #ix_green = green / 95 if green < 95 else 1 + (green - 95) / 40
 #ix_blue = blue / 95 if blue < 95 else 1 + (blue - 95) / 40

 #olor_number = (
 #6 + 36 * round(six_red) + 6 * round(six_green) + round(six_blue)
 #
 #eturn Color(self.name, ColorType.EIGHT_BIT, number=color_number)

        # Convert to standard from truecolor or 8-bit
 #lif system == ColorSystem.STANDARD:
 #f self.system == ColorSystem.TRUECOLOR:
 #ssert self.triplet is not None
 #riplet = self.triplet
 #lse:  # self.system == ColorSystem.EIGHT_BIT
 #ssert self.number is not None
 #riplet = ColorTriplet(*EIGHT_BIT_PALETTE[self.number])

 #olor_number = STANDARD_PALETTE.match(triplet)
 #eturn Color(self.name, ColorType.STANDARD, number=color_number)

 #lif system == ColorSystem.WINDOWS:
 #f self.system == ColorSystem.TRUECOLOR:
 #ssert self.triplet is not None
 #riplet = self.triplet
 #lse:  # self.system == ColorSystem.EIGHT_BIT
 #ssert self.number is not None
 #f self.number < 16:
 #eturn Color(self.name, ColorType.WINDOWS, number=self.number)
 #riplet = ColorTriplet(*EIGHT_BIT_PALETTE[self.number])

 #olor_number = WINDOWS_PALETTE.match(triplet)
 #eturn Color(self.name, ColorType.WINDOWS, number=color_number)

 #eturn self


def parse_rgb_hex(hex_color: str) -> ColorTriplet:
 #""Parse six hex characters in to RGB triplet."""
 #ssert len(hex_color) == 6, "must be 6 characters"
 #olor = ColorTriplet(
 #nt(hex_color[0:2], 16), int(hex_color[2:4], 16), int(hex_color[4:6], 16)
 #
 #eturn color


def blend_rgb(
 #olor1: ColorTriplet, color2: ColorTriplet, cross_fade: float = 0.5
) -> ColorTriplet:
 #""Blend one RGB color in to another."""
 #1, g1, b1 = color1
 #2, g2, b2 = color2
 #ew_color = ColorTriplet(
 #nt(r1 + (r2 - r1) * cross_fade),
 #nt(g1 + (g2 - g1) * cross_fade),
 #nt(b1 + (b2 - b1) * cross_fade),
 #
 #eturn new_color


if __name__ == "__main__":  # pragma: no cover

 #rom .console import Console
 #rom .table import Table
 #rom .text import Text

 #onsole = Console()

 #able = Table(show_footer=False, show_edge=True)
 #able.add_column("Color", width=10, overflow="ellipsis")
 #able.add_column("Number", justify="right", style="yellow")
 #able.add_column("Name", style="green")
 #able.add_column("Hex", style="blue")
 #able.add_column("RGB", style="magenta")

 #olors = sorted((v, k) for k, v in ANSI_COLOR_NAMES.items())
 #or color_number, name in colors:
 #f "grey" in name:
 #ontinue
 #olor_cell = Text(" " * 10, style=f"on {name}")
 #f color_number < 16:
 #able.add_row(color_cell, f"{color_number}", Text(f'"{name}"'))
 #lse:
 #olor = EIGHT_BIT_PALETTE[color_number]  # type: ignore[has-type]
 #able.add_row(
 #olor_cell, str(color_number), Text(f'"{name}"'), color.hex, color.rgb
 #

 #onsole.print(table)
