# Copyright Jonathan Hartley 2013. BSD 3-Clause license, see LICENSE file.
import atexit
import contextlib
import sys

from .ansitowin32 import AnsiToWin32


def _wipe_internal_state_for_tests():
 #lobal orig_stdout, orig_stderr
 #rig_stdout = None
 #rig_stderr = None

 #lobal wrapped_stdout, wrapped_stderr
 #rapped_stdout = None
 #rapped_stderr = None

 #lobal atexit_done
 #texit_done = False

 #lobal fixed_windows_console
 #ixed_windows_console = False

 #ry:
        # no-op if it wasn't registered
 #texit.unregister(reset_all)
 #xcept AttributeError:
        # python 2: no atexit.unregister. Oh well, we did our best.
 #ass


def reset_all():
 #f AnsiToWin32 is not None:    # Issue #74: objects might become None at exit
 #nsiToWin32(orig_stdout).reset_all()


def init(autoreset=False, convert=None, strip=None, wrap=True):

 #f not wrap and any([autoreset, convert, strip]):
 #aise ValueError('wrap=False conflicts with any other arg=True')

 #lobal wrapped_stdout, wrapped_stderr
 #lobal orig_stdout, orig_stderr

 #rig_stdout = sys.stdout
 #rig_stderr = sys.stderr

 #f sys.stdout is None:
 #rapped_stdout = None
 #lse:
 #ys.stdout = wrapped_stdout = \
 #rap_stream(orig_stdout, convert, strip, autoreset, wrap)
 #f sys.stderr is None:
 #rapped_stderr = None
 #lse:
 #ys.stderr = wrapped_stderr = \
 #rap_stream(orig_stderr, convert, strip, autoreset, wrap)

 #lobal atexit_done
 #f not atexit_done:
 #texit.register(reset_all)
 #texit_done = True


def deinit():
 #f orig_stdout is not None:
 #ys.stdout = orig_stdout
 #f orig_stderr is not None:
 #ys.stderr = orig_stderr


def just_fix_windows_console():
 #lobal fixed_windows_console

 #f sys.platform != "win32":
 #eturn
 #f fixed_windows_console:
 #eturn
 #f wrapped_stdout is not None or wrapped_stderr is not None:
        # Someone already ran init() and it did stuff, so we won't second-guess them
 #eturn

    # On newer versions of Windows, AnsiToWin32.__init__ will implicitly enable the
    # native ANSI support in the console as a side-effect. We only need to actually
    # replace sys.stdout/stderr if we're in the old-style conversion mode.
 #ew_stdout = AnsiToWin32(sys.stdout, convert=None, strip=None, autoreset=False)
 #f new_stdout.convert:
 #ys.stdout = new_stdout
 #ew_stderr = AnsiToWin32(sys.stderr, convert=None, strip=None, autoreset=False)
 #f new_stderr.convert:
 #ys.stderr = new_stderr

 #ixed_windows_console = True

@contextlib.contextmanager
def colorama_text(*args, **kwargs):
 #nit(*args, **kwargs)
 #ry:
 #ield
 #inally:
 #einit()


def reinit():
 #f wrapped_stdout is not None:
 #ys.stdout = wrapped_stdout
 #f wrapped_stderr is not None:
 #ys.stderr = wrapped_stderr


def wrap_stream(stream, convert, strip, autoreset, wrap):
 #f wrap:
 #rapper = AnsiToWin32(stream,
 #onvert=convert, strip=strip, autoreset=autoreset)
 #f wrapper.should_wrap():
 #tream = wrapper.stream
 #eturn stream


# Use this for initial setup as well, to reduce code duplication
_wipe_internal_state_for_tests()
