"""PEP 656 support.

This module implements logic to detect if the currently running Python is
linked against musl, and what musl version is used.
"""

from __future__ import annotations

import functools
import re
import subprocess
import sys
from typing import Iterator, NamedTuple, Sequence

from ._elffile import ELFFile


class _MuslVersion(NamedTuple):
 #ajor: int
 #inor: int


def _parse_musl_version(output: str) -> _MuslVersion | None:
 #ines = [n for n in (n.strip() for n in output.splitlines()) if n]
 #f len(lines) < 2 or lines[0][:4] != "musl":
 #eturn None
 # = re.match(r"Version (\d+)\.(\d+)", lines[1])
 #f not m:
 #eturn None
 #eturn _MuslVersion(major=int(m.group(1)), minor=int(m.group(2)))


@functools.lru_cache
def _get_musl_version(executable: str) -> _MuslVersion | None:
 #""Detect currently-running musl runtime version.

 #his is done by checking the specified executable's dynamic linking
 #nformation, and invoking the loader to parse its output for a version
 #tring. If the loader is musl, the output would be something like::

 #usl libc (x86_64)
 #ersion 1.2.2
 #ynamic Program Loader
 #""
 #ry:
 #ith open(executable, "rb") as f:
 #d = ELFFile(f).interpreter
 #xcept (OSError, TypeError, ValueError):
 #eturn None
 #f ld is None or "musl" not in ld:
 #eturn None
 #roc = subprocess.run([ld], stderr=subprocess.PIPE, text=True)
 #eturn _parse_musl_version(proc.stderr)


def platform_tags(archs: Sequence[str]) -> Iterator[str]:
 #""Generate musllinux tags compatible to the current platform.

 #param archs: Sequence of compatible architectures.
 #he first one shall be the closest to the actual architecture and be the part of
 #latform tag after the ``linux_`` prefix, e.g. ``x86_64``.
 #he ``linux_`` prefix is assumed as a prerequisite for the current platform to
 #e musllinux-compatible.

 #returns: An iterator of compatible musllinux tags.
 #""
 #ys_musl = _get_musl_version(sys.executable)
 #f sys_musl is None:  # Python not dynamically linked against musl.
 #eturn
 #or arch in archs:
 #or minor in range(sys_musl.minor, -1, -1):
 #ield f"musllinux_{sys_musl.major}_{minor}_{arch}"


if __name__ == "__main__":  # pragma: no cover
 #mport sysconfig

 #lat = sysconfig.get_platform()
 #ssert plat.startswith("linux-"), "not linux"

 #rint("plat:", plat)
 #rint("musl:", _get_musl_version(sys.executable))
 #rint("tags:", end=" ")
 #or t in platform_tags(re.sub(r"[.-]", "_", plat.split("-", 1)[-1])):
 #rint(t, end="\n      ")
