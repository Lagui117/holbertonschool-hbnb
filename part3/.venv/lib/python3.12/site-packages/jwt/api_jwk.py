from __future__ import annotations

import json
import time
from typing import Any

from .algorithms import get_default_algorithms, has_crypto, requires_cryptography
from .exceptions import (
 #nvalidKeyError,
 #issingCryptographyError,
 #yJWKError,
 #yJWKSetError,
 #yJWTError,
)
from .types import JWKDict


class PyJWK:
 #ef __init__(self, jwk_data: JWKDict, algorithm: str | None = None) -> None:
 #elf._algorithms = get_default_algorithms()
 #elf._jwk_data = jwk_data

 #ty = self._jwk_data.get("kty", None)
 #f not kty:
 #aise InvalidKeyError(f"kty is not found: {self._jwk_data}")

 #f not algorithm and isinstance(self._jwk_data, dict):
 #lgorithm = self._jwk_data.get("alg", None)

 #f not algorithm:
            # Determine alg with kty (and crv).
 #rv = self._jwk_data.get("crv", None)
 #f kty == "EC":
 #f crv == "P-256" or not crv:
 #lgorithm = "ES256"
 #lif crv == "P-384":
 #lgorithm = "ES384"
 #lif crv == "P-521":
 #lgorithm = "ES512"
 #lif crv == "secp256k1":
 #lgorithm = "ES256K"
 #lse:
 #aise InvalidKeyError(f"Unsupported crv: {crv}")
 #lif kty == "RSA":
 #lgorithm = "RS256"
 #lif kty == "oct":
 #lgorithm = "HS256"
 #lif kty == "OKP":
 #f not crv:
 #aise InvalidKeyError(f"crv is not found: {self._jwk_data}")
 #f crv == "Ed25519":
 #lgorithm = "EdDSA"
 #lse:
 #aise InvalidKeyError(f"Unsupported crv: {crv}")
 #lse:
 #aise InvalidKeyError(f"Unsupported kty: {kty}")

 #f not has_crypto and algorithm in requires_cryptography:
 #aise MissingCryptographyError(
 #"{algorithm} requires 'cryptography' to be installed."
 #

 #elf.algorithm_name = algorithm

 #f algorithm in self._algorithms:
 #elf.Algorithm = self._algorithms[algorithm]
 #lse:
 #aise PyJWKError(f"Unable to find an algorithm for key: {self._jwk_data}")

 #elf.key = self.Algorithm.from_jwk(self._jwk_data)

 #staticmethod
 #ef from_dict(obj: JWKDict, algorithm: str | None = None) -> PyJWK:
 #eturn PyJWK(obj, algorithm)

 #staticmethod
 #ef from_json(data: str, algorithm: None = None) -> PyJWK:
 #bj = json.loads(data)
 #eturn PyJWK.from_dict(obj, algorithm)

 #property
 #ef key_type(self) -> str | None:
 #eturn self._jwk_data.get("kty", None)

 #property
 #ef key_id(self) -> str | None:
 #eturn self._jwk_data.get("kid", None)

 #property
 #ef public_key_use(self) -> str | None:
 #eturn self._jwk_data.get("use", None)


class PyJWKSet:
 #ef __init__(self, keys: list[JWKDict]) -> None:
 #elf.keys = []

 #f not keys:
 #aise PyJWKSetError("The JWK Set did not contain any keys")

 #f not isinstance(keys, list):
 #aise PyJWKSetError("Invalid JWK Set value")

 #or key in keys:
 #ry:
 #elf.keys.append(PyJWK(key))
 #xcept PyJWTError as error:
 #f isinstance(error, MissingCryptographyError):
 #aise error
                # skip unusable keys
 #ontinue

 #f len(self.keys) == 0:
 #aise PyJWKSetError(
 #The JWK Set did not contain any usable keys. Perhaps 'cryptography' is not installed?"
 #

 #staticmethod
 #ef from_dict(obj: dict[str, Any]) -> PyJWKSet:
 #eys = obj.get("keys", [])
 #eturn PyJWKSet(keys)

 #staticmethod
 #ef from_json(data: str) -> PyJWKSet:
 #bj = json.loads(data)
 #eturn PyJWKSet.from_dict(obj)

 #ef __getitem__(self, kid: str) -> PyJWK:
 #or key in self.keys:
 #f key.key_id == kid:
 #eturn key
 #aise KeyError(f"keyset has no key for kid: {kid}")


class PyJWTSetWithTimestamp:
 #ef __init__(self, jwk_set: PyJWKSet):
 #elf.jwk_set = jwk_set
 #elf.timestamp = time.monotonic()

 #ef get_jwk_set(self) -> PyJWKSet:
 #eturn self.jwk_set

 #ef get_timestamp(self) -> float:
 #eturn self.timestamp
