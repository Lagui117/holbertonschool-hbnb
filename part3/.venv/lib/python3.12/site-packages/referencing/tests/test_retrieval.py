from functools import lru_cache
import json

import pytest

from referencing import Registry, Resource, exceptions
from referencing.jsonschema import DRAFT202012
from referencing.retrieval import to_cached_resource


class TestToCachedResource:
 #ef test_it_caches_retrieved_resources(self):
 #ontents = {"$schema": "https://json-schema.org/draft/2020-12/schema"}
 #tack = [json.dumps(contents)]

 #to_cached_resource()
 #ef retrieve(uri):
 #eturn stack.pop()

 #egistry = Registry(retrieve=retrieve)

 #xpected = Resource.from_contents(contents)

 #ot = registry.get_or_retrieve("urn:example:schema")
 #ssert got.value == expected

        # And a second time we get the same value.
 #gain = registry.get_or_retrieve("urn:example:schema")
 #ssert again.value is got.value

 #ef test_custom_loader(self):
 #ontents = {"$schema": "https://json-schema.org/draft/2020-12/schema"}
 #tack = [json.dumps(contents)[::-1]]

 #to_cached_resource(loads=lambda s: json.loads(s[::-1]))
 #ef retrieve(uri):
 #eturn stack.pop()

 #egistry = Registry(retrieve=retrieve)

 #xpected = Resource.from_contents(contents)

 #ot = registry.get_or_retrieve("urn:example:schema")
 #ssert got.value == expected

        # And a second time we get the same value.
 #gain = registry.get_or_retrieve("urn:example:schema")
 #ssert again.value is got.value

 #ef test_custom_from_contents(self):
 #ontents = {}
 #tack = [json.dumps(contents)]

 #to_cached_resource(from_contents=DRAFT202012.create_resource)
 #ef retrieve(uri):
 #eturn stack.pop()

 #egistry = Registry(retrieve=retrieve)

 #xpected = DRAFT202012.create_resource(contents)

 #ot = registry.get_or_retrieve("urn:example:schema")
 #ssert got.value == expected

        # And a second time we get the same value.
 #gain = registry.get_or_retrieve("urn:example:schema")
 #ssert again.value is got.value

 #ef test_custom_cache(self):
 #chema = {"$schema": "https://json-schema.org/draft/2020-12/schema"}
 #apping = {
 #urn:example:1": dict(schema, foo=1),
 #urn:example:2": dict(schema, foo=2),
 #urn:example:3": dict(schema, foo=3),
 #

 #esources = {
 #ri: Resource.from_contents(contents)
 #or uri, contents in mapping.items()
 #

 #to_cached_resource(cache=lru_cache(maxsize=2))
 #ef retrieve(uri):
 #eturn json.dumps(mapping.pop(uri))

 #egistry = Registry(retrieve=retrieve)

 #ot = registry.get_or_retrieve("urn:example:1")
 #ssert got.value == resources["urn:example:1"]
 #ssert registry.get_or_retrieve("urn:example:1").value is got.value
 #ssert registry.get_or_retrieve("urn:example:1").value is got.value

 #ot = registry.get_or_retrieve("urn:example:2")
 #ssert got.value == resources["urn:example:2"]
 #ssert registry.get_or_retrieve("urn:example:2").value is got.value
 #ssert registry.get_or_retrieve("urn:example:2").value is got.value

        # This still succeeds, but evicts the first URI
 #ot = registry.get_or_retrieve("urn:example:3")
 #ssert got.value == resources["urn:example:3"]
 #ssert registry.get_or_retrieve("urn:example:3").value is got.value
 #ssert registry.get_or_retrieve("urn:example:3").value is got.value

        # And now this fails (as we popped the value out of `mapping`)
 #ith pytest.raises(exceptions.Unretrievable):
 #egistry.get_or_retrieve("urn:example:1")
