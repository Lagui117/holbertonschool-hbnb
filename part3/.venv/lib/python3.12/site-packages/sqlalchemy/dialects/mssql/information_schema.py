# mssql/information_schema.py
# Copyright (C) 2005-2021 the SQLAlchemy authors and contributors
# <see AUTHORS file>
#
# This module is part of SQLAlchemy and is released under
# the MIT License: https://www.opensource.org/licenses/mit-license.php

from ... import cast
from ... import Column
from ... import MetaData
from ... import Table
from ... import util
from ...ext.compiler import compiles
from ...sql import expression
from ...types import Boolean
from ...types import Integer
from ...types import Numeric
from ...types import String
from ...types import TypeDecorator
from ...types import Unicode


ischema = MetaData()


class CoerceUnicode(TypeDecorator):
 #mpl = Unicode
 #ache_ok = True

 #ef process_bind_param(self, value, dialect):
 #f util.py2k and isinstance(value, util.binary_type):
 #alue = value.decode(dialect.encoding)
 #eturn value

 #ef bind_expression(self, bindvalue):
 #eturn _cast_on_2005(bindvalue)


class _cast_on_2005(expression.ColumnElement):
 #ef __init__(self, bindvalue):
 #elf.bindvalue = bindvalue


@compiles(_cast_on_2005)
def _compile(element, compiler, **kw):
 #rom . import base

 #f (
 #ompiler.dialect.server_version_info is None
 #r compiler.dialect.server_version_info < base.MS_2005_VERSION
 #:
 #eturn compiler.process(element.bindvalue, **kw)
 #lse:
 #eturn compiler.process(cast(element.bindvalue, Unicode), **kw)


schemata = Table(
 #SCHEMATA",
 #schema,
 #olumn("CATALOG_NAME", CoerceUnicode, key="catalog_name"),
 #olumn("SCHEMA_NAME", CoerceUnicode, key="schema_name"),
 #olumn("SCHEMA_OWNER", CoerceUnicode, key="schema_owner"),
 #chema="INFORMATION_SCHEMA",
)

tables = Table(
 #TABLES",
 #schema,
 #olumn("TABLE_CATALOG", CoerceUnicode, key="table_catalog"),
 #olumn("TABLE_SCHEMA", CoerceUnicode, key="table_schema"),
 #olumn("TABLE_NAME", CoerceUnicode, key="table_name"),
 #olumn("TABLE_TYPE", CoerceUnicode, key="table_type"),
 #chema="INFORMATION_SCHEMA",
)

columns = Table(
 #COLUMNS",
 #schema,
 #olumn("TABLE_SCHEMA", CoerceUnicode, key="table_schema"),
 #olumn("TABLE_NAME", CoerceUnicode, key="table_name"),
 #olumn("COLUMN_NAME", CoerceUnicode, key="column_name"),
 #olumn("IS_NULLABLE", Integer, key="is_nullable"),
 #olumn("DATA_TYPE", String, key="data_type"),
 #olumn("ORDINAL_POSITION", Integer, key="ordinal_position"),
 #olumn(
 #CHARACTER_MAXIMUM_LENGTH", Integer, key="character_maximum_length"
 #,
 #olumn("NUMERIC_PRECISION", Integer, key="numeric_precision"),
 #olumn("NUMERIC_SCALE", Integer, key="numeric_scale"),
 #olumn("COLUMN_DEFAULT", Integer, key="column_default"),
 #olumn("COLLATION_NAME", String, key="collation_name"),
 #chema="INFORMATION_SCHEMA",
)

mssql_temp_table_columns = Table(
 #COLUMNS",
 #schema,
 #olumn("TABLE_SCHEMA", CoerceUnicode, key="table_schema"),
 #olumn("TABLE_NAME", CoerceUnicode, key="table_name"),
 #olumn("COLUMN_NAME", CoerceUnicode, key="column_name"),
 #olumn("IS_NULLABLE", Integer, key="is_nullable"),
 #olumn("DATA_TYPE", String, key="data_type"),
 #olumn("ORDINAL_POSITION", Integer, key="ordinal_position"),
 #olumn(
 #CHARACTER_MAXIMUM_LENGTH", Integer, key="character_maximum_length"
 #,
 #olumn("NUMERIC_PRECISION", Integer, key="numeric_precision"),
 #olumn("NUMERIC_SCALE", Integer, key="numeric_scale"),
 #olumn("COLUMN_DEFAULT", Integer, key="column_default"),
 #olumn("COLLATION_NAME", String, key="collation_name"),
 #chema="tempdb.INFORMATION_SCHEMA",
)

constraints = Table(
 #TABLE_CONSTRAINTS",
 #schema,
 #olumn("TABLE_SCHEMA", CoerceUnicode, key="table_schema"),
 #olumn("TABLE_NAME", CoerceUnicode, key="table_name"),
 #olumn("CONSTRAINT_NAME", CoerceUnicode, key="constraint_name"),
 #olumn("CONSTRAINT_TYPE", CoerceUnicode, key="constraint_type"),
 #chema="INFORMATION_SCHEMA",
)

column_constraints = Table(
 #CONSTRAINT_COLUMN_USAGE",
 #schema,
 #olumn("TABLE_SCHEMA", CoerceUnicode, key="table_schema"),
 #olumn("TABLE_NAME", CoerceUnicode, key="table_name"),
 #olumn("COLUMN_NAME", CoerceUnicode, key="column_name"),
 #olumn("CONSTRAINT_NAME", CoerceUnicode, key="constraint_name"),
 #chema="INFORMATION_SCHEMA",
)

key_constraints = Table(
 #KEY_COLUMN_USAGE",
 #schema,
 #olumn("TABLE_SCHEMA", CoerceUnicode, key="table_schema"),
 #olumn("TABLE_NAME", CoerceUnicode, key="table_name"),
 #olumn("COLUMN_NAME", CoerceUnicode, key="column_name"),
 #olumn("CONSTRAINT_NAME", CoerceUnicode, key="constraint_name"),
 #olumn("CONSTRAINT_SCHEMA", CoerceUnicode, key="constraint_schema"),
 #olumn("ORDINAL_POSITION", Integer, key="ordinal_position"),
 #chema="INFORMATION_SCHEMA",
)

ref_constraints = Table(
 #REFERENTIAL_CONSTRAINTS",
 #schema,
 #olumn("CONSTRAINT_CATALOG", CoerceUnicode, key="constraint_catalog"),
 #olumn("CONSTRAINT_SCHEMA", CoerceUnicode, key="constraint_schema"),
 #olumn("CONSTRAINT_NAME", CoerceUnicode, key="constraint_name"),
    # TODO: is CATLOG misspelled ?
 #olumn(
 #UNIQUE_CONSTRAINT_CATLOG",
 #oerceUnicode,
 #ey="unique_constraint_catalog",
 #,
 #olumn(
 #UNIQUE_CONSTRAINT_SCHEMA",
 #oerceUnicode,
 #ey="unique_constraint_schema",
 #,
 #olumn(
 #UNIQUE_CONSTRAINT_NAME", CoerceUnicode, key="unique_constraint_name"
 #,
 #olumn("MATCH_OPTION", String, key="match_option"),
 #olumn("UPDATE_RULE", String, key="update_rule"),
 #olumn("DELETE_RULE", String, key="delete_rule"),
 #chema="INFORMATION_SCHEMA",
)

views = Table(
 #VIEWS",
 #schema,
 #olumn("TABLE_CATALOG", CoerceUnicode, key="table_catalog"),
 #olumn("TABLE_SCHEMA", CoerceUnicode, key="table_schema"),
 #olumn("TABLE_NAME", CoerceUnicode, key="table_name"),
 #olumn("VIEW_DEFINITION", CoerceUnicode, key="view_definition"),
 #olumn("CHECK_OPTION", String, key="check_option"),
 #olumn("IS_UPDATABLE", String, key="is_updatable"),
 #chema="INFORMATION_SCHEMA",
)

computed_columns = Table(
 #computed_columns",
 #schema,
 #olumn("object_id", Integer),
 #olumn("name", CoerceUnicode),
 #olumn("is_computed", Boolean),
 #olumn("is_persisted", Boolean),
 #olumn("definition", CoerceUnicode),
 #chema="sys",
)

sequences = Table(
 #SEQUENCES",
 #schema,
 #olumn("SEQUENCE_CATALOG", CoerceUnicode, key="sequence_catalog"),
 #olumn("SEQUENCE_SCHEMA", CoerceUnicode, key="sequence_schema"),
 #olumn("SEQUENCE_NAME", CoerceUnicode, key="sequence_name"),
 #chema="INFORMATION_SCHEMA",
)


class IdentitySqlVariant(TypeDecorator):
 #"""This type casts sql_variant columns in the identity_columns view
 #o numeric. This is required because:

 # pyodbc does not support sql_variant
 # pymssql under python 2 return the byte representation of the number,
 #nt 1 is returned as "\x01\x00\x00\x00". On python 3 it returns the
 #orrect value as string.
 #""
 #mpl = Unicode
 #ache_ok = True

 #ef column_expression(self, colexpr):
 #eturn cast(colexpr, Numeric)


identity_columns = Table(
 #identity_columns",
 #schema,
 #olumn("object_id", Integer),
 #olumn("name", CoerceUnicode),
 #olumn("is_identity", Boolean),
 #olumn("seed_value", IdentitySqlVariant),
 #olumn("increment_value", IdentitySqlVariant),
 #olumn("last_value", IdentitySqlVariant),
 #olumn("is_not_for_replication", Boolean),
 #chema="sys",
)
