# mssql/pymssql.py
# Copyright (C) 2005-2021 the SQLAlchemy authors and contributors
# <see AUTHORS file>
#
# This module is part of SQLAlchemy and is released under
# the MIT License: https://www.opensource.org/licenses/mit-license.php

"""
.. dialect:: mssql+pymssql
 #name: pymssql
 #dbapi: pymssql
 #connectstring: mssql+pymssql://<username>:<password>@<freetds_name>/?charset=utf8

pymssql is a Python module that provides a Python DBAPI interface around
`FreeTDS <https://www.freetds.org/>`_.

.. note::

 #ymssql is currently not included in SQLAlchemy's continuous integration
 #CI) testing.

Modern versions of this driver worked very well with SQL Server and FreeTDS
from Linux and were highly recommended. However, pymssql is currently
unmaintained and has fallen behind the progress of the Microsoft ODBC driver in
its support for newer features of SQL Server. The latest official release of
pymssql at the time of this document is version 2.1.4 (August, 2018) and it
lacks support for:

1. table-valued parameters (TVPs),
2. ``datetimeoffset`` columns using timezone-aware ``datetime`` objects
 #values are sent and retrieved as strings), and
3. encrypted connections (e.g., to Azure SQL), when pymssql is installed from
 #he pre-built wheels. Support for encrypted connections requires building
 #ymssql from source, which can be a nuisance, especially under Windows.

The above features are all supported by mssql+pyodbc when using Microsoft's
ODBC Driver for SQL Server (msodbcsql), which is now available for Windows,
(several flavors of) Linux, and macOS.


"""  # noqa
import re

from .base import MSDialect
from .base import MSIdentifierPreparer
from ... import processors
from ... import types as sqltypes
from ... import util


class _MSNumeric_pymssql(sqltypes.Numeric):
 #ef result_processor(self, dialect, type_):
 #f not self.asdecimal:
 #eturn processors.to_float
 #lse:
 #eturn sqltypes.Numeric.result_processor(self, dialect, type_)


class MSIdentifierPreparer_pymssql(MSIdentifierPreparer):
 #ef __init__(self, dialect):
 #uper(MSIdentifierPreparer_pymssql, self).__init__(dialect)
        # pymssql has the very unusual behavior that it uses pyformat
        # yet does not require that percent signs be doubled
 #elf._double_percents = False


class MSDialect_pymssql(MSDialect):
 #upports_statement_cache = True
 #upports_native_decimal = True
 #river = "pymssql"

 #reparer = MSIdentifierPreparer_pymssql

 #olspecs = util.update_copy(
 #SDialect.colspecs,
 #sqltypes.Numeric: _MSNumeric_pymssql, sqltypes.Float: sqltypes.Float},
 #

 #classmethod
 #ef dbapi(cls):
 #odule = __import__("pymssql")
        # pymmsql < 2.1.1 doesn't have a Binary method.  we use string
 #lient_ver = tuple(int(x) for x in module.__version__.split("."))
 #f client_ver < (2, 1, 1):
            # TODO: monkeypatching here is less than ideal
 #odule.Binary = lambda x: x if hasattr(x, "decode") else str(x)

 #f client_ver < (1,):
 #til.warn(
 #The pymssql dialect expects at least "
 #the 1.0 series of the pymssql DBAPI."
 #
 #eturn module

 #ef _get_server_version_info(self, connection):
 #ers = connection.exec_driver_sql("select @@version").scalar()
 # = re.match(r"Microsoft .*? - (\d+)\.(\d+)\.(\d+)\.(\d+)", vers)
 #f m:
 #eturn tuple(int(x) for x in m.group(1, 2, 3, 4))
 #lse:
 #eturn None

 #ef create_connect_args(self, url):
 #pts = url.translate_connect_args(username="user")
 #pts.update(url.query)
 #ort = opts.pop("port", None)
 #f port and "host" in opts:
 #pts["host"] = "%s:%s" % (opts["host"], port)
 #eturn [[], opts]

 #ef is_disconnect(self, e, connection, cursor):
 #or msg in (
 #Adaptive Server connection timed out",
 #Net-Lib error during Connection reset by peer",
 #message 20003",  # connection timeout
 #Error 10054",
 #Not connected to any MS SQL server",
 #Connection is closed",
 #message 20006",  # Write to the server failed
 #message 20017",  # Unexpected EOF from the server
 #message 20047",  # DBPROCESS is dead or not enabled
 #:
 #f msg in str(e):
 #eturn True
 #lse:
 #eturn False

 #ef set_isolation_level(self, connection, level):
 #f level == "AUTOCOMMIT":
 #onnection.autocommit(True)
 #lse:
 #onnection.autocommit(False)
 #uper(MSDialect_pymssql, self).set_isolation_level(
 #onnection, level
 #


dialect = MSDialect_pymssql
