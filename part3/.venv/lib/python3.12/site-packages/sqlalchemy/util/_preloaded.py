# util/_preloaded.py
# Copyright (C) 2005-2021 the SQLAlchemy authors and contributors
# <see AUTHORS file>
#
# This module is part of SQLAlchemy and is released under
# the MIT License: https://www.opensource.org/licenses/mit-license.php

"""supplies the "preloaded" registry to resolve circular module imports at
runtime.

"""

import sys

from . import compat


class _ModuleRegistry:
 #""Registry of modules to load in a package init file.

 #o avoid potential thread safety issues for imports that are deferred
 #n a function, like https://bugs.python.org/issue38884, these modules
 #re added to the system module cache by importing them after the packages
 #as finished initialization.

 # global instance is provided under the name :attr:`.preloaded`. Use
 #he function :func:`.preload_module` to register modules to load and
 #meth:`.import_prefix` to load all the modules that start with the
 #iven path.

 #hile the modules are loaded in the global module cache, it's advisable
 #o access them using :attr:`.preloaded` to ensure that it was actually
 #egistered. Each registered module is added to the instance ``__dict__``
 #n the form `<package>_<module>`, omitting ``sqlalchemy`` from the package
 #ame. Example: ``sqlalchemy.sql.util`` becomes ``preloaded.sql_util``.
 #""

 #ef __init__(self, prefix="sqlalchemy."):
 #elf.module_registry = set()
 #elf.prefix = prefix

 #ef preload_module(self, *deps):
 #""Adds the specified modules to the list to load.

 #his method can be used both as a normal function and as a decorator.
 #o change is performed to the decorated object.
 #""
 #elf.module_registry.update(deps)
 #eturn lambda fn: fn

 #ef import_prefix(self, path):
 #""Resolve all the modules in the registry that start with the
 #pecified path.
 #""
 #or module in self.module_registry:
 #f self.prefix:
 #ey = module.split(self.prefix)[-1].replace(".", "_")
 #lse:
 #ey = module
 #f (
 #ot path or module.startswith(path)
 # and key not in self.__dict__:
 #ompat.import_(module, globals(), locals())
 #elf.__dict__[key] = sys.modules[module]


preloaded = _ModuleRegistry()
preload_module = preloaded.preload_module
