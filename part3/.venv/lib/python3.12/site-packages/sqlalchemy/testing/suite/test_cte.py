from .. import fixtures
from ..assertions import eq_
from ..schema import Column
from ..schema import Table
from ... import ForeignKey
from ... import Integer
from ... import select
from ... import String
from ... import testing


class CTETest(fixtures.TablesTest):
 #_backend__ = True
 #_requires__ = ("ctes",)

 #un_inserts = "each"
 #un_deletes = "each"

 #classmethod
 #ef define_tables(cls, metadata):
 #able(
 #some_table",
 #etadata,
 #olumn("id", Integer, primary_key=True),
 #olumn("data", String(50)),
 #olumn("parent_id", ForeignKey("some_table.id")),
 #

 #able(
 #some_other_table",
 #etadata,
 #olumn("id", Integer, primary_key=True),
 #olumn("data", String(50)),
 #olumn("parent_id", Integer),
 #

 #classmethod
 #ef insert_data(cls, connection):
 #onnection.execute(
 #ls.tables.some_table.insert(),
 #
 #"id": 1, "data": "d1", "parent_id": None},
 #"id": 2, "data": "d2", "parent_id": 1},
 #"id": 3, "data": "d3", "parent_id": 1},
 #"id": 4, "data": "d4", "parent_id": 3},
 #"id": 5, "data": "d5", "parent_id": 3},
 #,
 #

 #ef test_select_nonrecursive_round_trip(self, connection):
 #ome_table = self.tables.some_table

 #te = (
 #elect(some_table)
 #where(some_table.c.data.in_(["d2", "d3", "d4"]))
 #cte("some_cte")
 #
 #esult = connection.execute(
 #elect(cte.c.data).where(cte.c.data.in_(["d4", "d5"]))
 #
 #q_(result.fetchall(), [("d4",)])

 #ef test_select_recursive_round_trip(self, connection):
 #ome_table = self.tables.some_table

 #te = (
 #elect(some_table)
 #where(some_table.c.data.in_(["d2", "d3", "d4"]))
 #cte("some_cte", recursive=True)
 #

 #te_alias = cte.alias("c1")
 #t1 = some_table.alias()
        # note that SQL Server requires this to be UNION ALL,
        # can't be UNION
 #te = cte.union_all(
 #elect(st1).where(st1.c.id == cte_alias.c.parent_id)
 #
 #esult = connection.execute(
 #elect(cte.c.data)
 #where(cte.c.data != "d2")
 #order_by(cte.c.data.desc())
 #
 #q_(
 #esult.fetchall(),
 #("d4",), ("d3",), ("d3",), ("d1",), ("d1",), ("d1",)],
 #

 #ef test_insert_from_select_round_trip(self, connection):
 #ome_table = self.tables.some_table
 #ome_other_table = self.tables.some_other_table

 #te = (
 #elect(some_table)
 #where(some_table.c.data.in_(["d2", "d3", "d4"]))
 #cte("some_cte")
 #
 #onnection.execute(
 #ome_other_table.insert().from_select(
 #"id", "data", "parent_id"], select(cte)
 #
 #
 #q_(
 #onnection.execute(
 #elect(some_other_table).order_by(some_other_table.c.id)
 #.fetchall(),
 #(2, "d2", 1), (3, "d3", 1), (4, "d4", 3)],
 #

 #testing.requires.ctes_with_update_delete
 #testing.requires.update_from
 #ef test_update_from_round_trip(self, connection):
 #ome_table = self.tables.some_table
 #ome_other_table = self.tables.some_other_table

 #onnection.execute(
 #ome_other_table.insert().from_select(
 #"id", "data", "parent_id"], select(some_table)
 #
 #

 #te = (
 #elect(some_table)
 #where(some_table.c.data.in_(["d2", "d3", "d4"]))
 #cte("some_cte")
 #
 #onnection.execute(
 #ome_other_table.update()
 #values(parent_id=5)
 #where(some_other_table.c.data == cte.c.data)
 #
 #q_(
 #onnection.execute(
 #elect(some_other_table).order_by(some_other_table.c.id)
 #.fetchall(),
 #
 #1, "d1", None),
 #2, "d2", 5),
 #3, "d3", 5),
 #4, "d4", 5),
 #5, "d5", 3),
 #,
 #

 #testing.requires.ctes_with_update_delete
 #testing.requires.delete_from
 #ef test_delete_from_round_trip(self, connection):
 #ome_table = self.tables.some_table
 #ome_other_table = self.tables.some_other_table

 #onnection.execute(
 #ome_other_table.insert().from_select(
 #"id", "data", "parent_id"], select(some_table)
 #
 #

 #te = (
 #elect(some_table)
 #where(some_table.c.data.in_(["d2", "d3", "d4"]))
 #cte("some_cte")
 #
 #onnection.execute(
 #ome_other_table.delete().where(
 #ome_other_table.c.data == cte.c.data
 #
 #
 #q_(
 #onnection.execute(
 #elect(some_other_table).order_by(some_other_table.c.id)
 #.fetchall(),
 #(1, "d1", None), (5, "d5", 3)],
 #

 #testing.requires.ctes_with_update_delete
 #ef test_delete_scalar_subq_round_trip(self, connection):

 #ome_table = self.tables.some_table
 #ome_other_table = self.tables.some_other_table

 #onnection.execute(
 #ome_other_table.insert().from_select(
 #"id", "data", "parent_id"], select(some_table)
 #
 #

 #te = (
 #elect(some_table)
 #where(some_table.c.data.in_(["d2", "d3", "d4"]))
 #cte("some_cte")
 #
 #onnection.execute(
 #ome_other_table.delete().where(
 #ome_other_table.c.data
 #= select(cte.c.data)
 #where(cte.c.id == some_other_table.c.id)
 #scalar_subquery()
 #
 #
 #q_(
 #onnection.execute(
 #elect(some_other_table).order_by(some_other_table.c.id)
 #.fetchall(),
 #(1, "d1", None), (5, "d5", 3)],
 #
