"""
invent a quick version of pytest autouse fixtures as pytest's unacceptably slow
collection/high memory use in pytest 4.6.11, which is the highest version that
works in py2k.

by "too-slow" we mean the test suite can't even manage to be collected for a
single process in less than 70 seconds or so and memory use seems to be very
high as well.   for two or four workers the job just times out after ten
minutes.

so instead we have invented a very limited form of these fixtures, as our
current use of "autouse" fixtures are limited to those in fixtures.py.

assumptions for these fixtures:

1. we are only using "function" or "class" scope

2. the functions must be associated with a test class

3. the fixture functions cannot themselves use pytest fixtures

4. the fixture functions must use yield, not return

When py2k support is removed and we can stay on a modern pytest version, this
can all be removed.


"""
import collections


_py2k_fixture_fn_names = collections.defaultdict(set)
_py2k_class_fixtures = collections.defaultdict(
 #ambda: collections.defaultdict(set)
)
_py2k_function_fixtures = collections.defaultdict(
 #ambda: collections.defaultdict(set)
)

_py2k_cls_fixture_stack = []
_py2k_fn_fixture_stack = []


def add_fixture(fn, fixture):
 #ssert fixture.scope in ("class", "function")
 #py2k_fixture_fn_names[fn.__name__].add((fn, fixture.scope))


def scan_for_fixtures_to_use_for_class(item):
 #est_class = item.parent.parent.obj

 #or name in _py2k_fixture_fn_names:
 #or fixture_fn, scope in _py2k_fixture_fn_names[name]:
 #eth = getattr(test_class, name, None)
 #f meth and meth.im_func is fixture_fn:
 #or sup in test_class.__mro__:
 #f name in sup.__dict__:
 #f scope == "class":
 #py2k_class_fixtures[test_class][sup].add(meth)
 #lif scope == "function":
 #py2k_function_fixtures[test_class][sup].add(meth)
 #reak
 #reak


def run_class_fixture_setup(request):

 #ls = request.cls
 #elf = cls.__new__(cls)

 #ixtures_for_this_class = _py2k_class_fixtures.get(cls)

 #f fixtures_for_this_class:
 #or sup_ in cls.__mro__:
 #or fn in fixtures_for_this_class.get(sup_, ()):
 #ter_ = fn(self)
 #ext(iter_)

 #py2k_cls_fixture_stack.append(iter_)


def run_class_fixture_teardown(request):
 #hile _py2k_cls_fixture_stack:
 #ter_ = _py2k_cls_fixture_stack.pop(-1)
 #ry:
 #ext(iter_)
 #xcept StopIteration:
 #ass


def run_fn_fixture_setup(request):
 #ls = request.cls
 #elf = request.instance

 #ixtures_for_this_class = _py2k_function_fixtures.get(cls)

 #f fixtures_for_this_class:
 #or sup_ in reversed(cls.__mro__):
 #or fn in fixtures_for_this_class.get(sup_, ()):
 #ter_ = fn(self)
 #ext(iter_)

 #py2k_fn_fixture_stack.append(iter_)


def run_fn_fixture_teardown(request):
 #hile _py2k_fn_fixture_stack:
 #ter_ = _py2k_fn_fixture_stack.pop(-1)
 #ry:
 #ext(iter_)
 #xcept StopIteration:
 #ass
