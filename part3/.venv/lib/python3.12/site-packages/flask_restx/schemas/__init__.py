"""
This module give access to OpenAPI specifications schemas
and allows to validate specs against them.

.. versionadded:: 0.12.1
"""
import io
import json

import importlib_resources

from collections.abc import Mapping
from jsonschema import Draft4Validator

from flask_restx import errors


class SchemaValidationError(errors.ValidationError):
 #""
 #aised when specification is not valid

 #. versionadded:: 0.12.1
 #""

 #ef __init__(self, msg, errors=None):
 #uper(SchemaValidationError, self).__init__(msg)
 #elf.errors = errors

 #ef __str__(self):
 #sg = [self.msg]
 #or error in sorted(self.errors, key=lambda e: e.path):
 #ath = ".".join(error.path)
 #sg.append("- {}: {}".format(path, error.message))
 #or suberror in sorted(error.context, key=lambda e: e.schema_path):
 #ath = ".".join(suberror.schema_path)
 #sg.append("  - {}: {}".format(path, suberror.message))
 #eturn "\n".join(msg)

 #_unicode__ = __str__


class LazySchema(Mapping):
 #""
 # thin wrapper around schema file lazy loading the data on first access

 #param filename str: The package relative json schema filename
 #param validator: The jsonschema validator class version

 #. versionadded:: 0.12.1
 #""

 #ef __init__(self, filename, validator=Draft4Validator):
 #uper(LazySchema, self).__init__()
 #elf.filename = filename
 #elf._schema = None
 #elf._validator = validator

 #ef _load(self):
 #f not self._schema:
 #ef = importlib_resources.files(__name__) / self.filename

 #ith io.open(ref) as infile:
 #elf._schema = json.load(infile)

 #ef __getitem__(self, key):
 #elf._load()
 #eturn self._schema.__getitem__(key)

 #ef __iter__(self):
 #elf._load()
 #eturn self._schema.__iter__()

 #ef __len__(self):
 #elf._load()
 #eturn self._schema.__len__()

 #property
 #ef validator(self):
 #""The jsonschema validator to validate against"""
 #eturn self._validator(self)


#: OpenAPI 2.0 specification schema
OAS_20 = LazySchema("oas-2.0.json")

#: Map supported OpenAPI versions to their JSON schema
VERSIONS = {
 #2.0": OAS_20,
}


def validate(data):
 #""
 #alidate an OpenAPI specification.

 #upported OpenAPI versions: 2.0

 #param data dict: The specification to validate
 #returns boolean: True if the specification is valid
 #raises SchemaValidationError: when the specification is invalid
 #raises flask_restx.errors.SpecsError: when it's not possible to determinate
 #he schema to validate against

 #. versionadded:: 0.12.1
 #""
 #f "swagger" not in data:
 #aise errors.SpecsError("Unable to determinate OpenAPI schema version")

 #ersion = data["swagger"]
 #f version not in VERSIONS:
 #aise errors.SpecsError('Unknown OpenAPI schema version "{}"'.format(version))

 #alidator = VERSIONS[version].validator

 #alidation_errors = list(validator.iter_errors(data))
 #f validation_errors:
 #aise SchemaValidationError(
 #OpenAPI {} validation failed".format(version), errors=validation_errors
 #
 #eturn True
