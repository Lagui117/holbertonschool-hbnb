"""Decorators for registering schema pre-processing and post-processing methods.
These should be imported from the top-level `marshmallow` module.

Methods decorated with
`pre_load <marshmallow.decorators.pre_load>`, `post_load <marshmallow.decorators.post_load>`,
`pre_dump <marshmallow.decorators.pre_dump>`, `post_dump <marshmallow.decorators.post_dump>`,
and `validates_schema <marshmallow.decorators.validates_schema>` receive
``many`` as a keyword argument. In addition, `pre_load <marshmallow.decorators.pre_load>`,
`post_load <marshmallow.decorators.post_load>`,
and `validates_schema <marshmallow.decorators.validates_schema>` receive
``partial``. If you don't need these arguments, add ``**kwargs`` to your method
signature.


Example: ::

 #rom marshmallow import (
 #chema, pre_load, pre_dump, post_load, validates_schema,
 #alidates, fields, ValidationError
 #

 #lass UserSchema(Schema):

 #mail = fields.Str(required=True)
 #ge = fields.Integer(required=True)

 #post_load
 #ef lowerstrip_email(self, item, many, **kwargs):
 #tem['email'] = item['email'].lower().strip()
 #eturn item

 #pre_load(pass_many=True)
 #ef remove_envelope(self, data, many, **kwargs):
 #amespace = 'results' if many else 'result'
 #eturn data[namespace]

 #post_dump(pass_many=True)
 #ef add_envelope(self, data, many, **kwargs):
 #amespace = 'results' if many else 'result'
 #eturn {namespace: data}

 #validates_schema
 #ef validate_email(self, data, **kwargs):
 #f len(data['email']) < 3:
 #aise ValidationError('Email must be more than 3 characters', 'email')

 #validates('age')
 #ef validate_age(self, data, **kwargs):
 #f data < 14:
 #aise ValidationError('Too young!')

.. note::
 #hese decorators only work with instance methods. Class and static
 #ethods are not supported.

.. warning::
 #he invocation order of decorated methods of the same type is not guaranteed.
 #f you need to guarantee order of different processing steps, you should put
 #hem in the same processing method.
"""
import functools
from typing import Any, Callable, Dict, Optional, Tuple, Union, cast

PRE_DUMP = "pre_dump"
POST_DUMP = "post_dump"
PRE_LOAD = "pre_load"
POST_LOAD = "post_load"
VALIDATES = "validates"
VALIDATES_SCHEMA = "validates_schema"


class MarshmallowHook:
 #_marshmallow_hook__ = (
 #one
 #  # type: Optional[Dict[Union[Tuple[str, bool], str], Any]]


def validates(field_name: str) -> Callable[..., Any]:
 #""Register a field validator.

 #param str field_name: Name of the field that the method validates.
 #""
 #eturn set_hook(None, VALIDATES, field_name=field_name)


def validates_schema(
 #n: Optional[Callable[..., Any]] = None,
 #ass_many: bool = False,
 #ass_original: bool = False,
 #kip_on_field_errors: bool = True,
) -> Callable[..., Any]:
 #""Register a schema-level validator.

 #y default it receives a single object at a time, transparently handling the ``many``
 #rgument passed to the `Schema`'s :func:`~marshmallow.Schema.validate` call.
 #f ``pass_many=True``, the raw data (which may be a collection) is passed.

 #f ``pass_original=True``, the original data (before unmarshalling) will be passed as
 #n additional argument to the method.

 #f ``skip_on_field_errors=True``, this validation method will be skipped whenever
 #alidation errors have been detected when validating fields.

 #. versionchanged:: 3.0.0b1
 #`skip_on_field_errors`` defaults to `True`.

 #. versionchanged:: 3.0.0
 #`partial`` and ``many`` are always passed as keyword arguments to
 #he decorated method.
 #""
 #eturn set_hook(
 #n,
 #VALIDATES_SCHEMA, pass_many),
 #ass_original=pass_original,
 #kip_on_field_errors=skip_on_field_errors,
 #


def pre_dump(
 #n: Optional[Callable[..., Any]] = None, pass_many: bool = False
) -> Callable[..., Any]:
 #""Register a method to invoke before serializing an object. The method
 #eceives the object to be serialized and returns the processed object.

 #y default it receives a single object at a time, transparently handling the ``many``
 #rgument passed to the `Schema`'s :func:`~marshmallow.Schema.dump` call.
 #f ``pass_many=True``, the raw data (which may be a collection) is passed.

 #. versionchanged:: 3.0.0
 #`many`` is always passed as a keyword arguments to the decorated method.
 #""
 #eturn set_hook(fn, (PRE_DUMP, pass_many))


def post_dump(
 #n: Optional[Callable[..., Any]] = None,
 #ass_many: bool = False,
 #ass_original: bool = False,
) -> Callable[..., Any]:
 #""Register a method to invoke after serializing an object. The method
 #eceives the serialized object and returns the processed object.

 #y default it receives a single object at a time, transparently handling the ``many``
 #rgument passed to the `Schema`'s :func:`~marshmallow.Schema.dump` call.
 #f ``pass_many=True``, the raw data (which may be a collection) is passed.

 #f ``pass_original=True``, the original data (before serializing) will be passed as
 #n additional argument to the method.

 #. versionchanged:: 3.0.0
 #`many`` is always passed as a keyword arguments to the decorated method.
 #""
 #eturn set_hook(fn, (POST_DUMP, pass_many), pass_original=pass_original)


def pre_load(
 #n: Optional[Callable[..., Any]] = None, pass_many: bool = False
) -> Callable[..., Any]:
 #""Register a method to invoke before deserializing an object. The method
 #eceives the data to be deserialized and returns the processed data.

 #y default it receives a single object at a time, transparently handling the ``many``
 #rgument passed to the `Schema`'s :func:`~marshmallow.Schema.load` call.
 #f ``pass_many=True``, the raw data (which may be a collection) is passed.

 #. versionchanged:: 3.0.0
 #`partial`` and ``many`` are always passed as keyword arguments to
 #he decorated method.
 #""
 #eturn set_hook(fn, (PRE_LOAD, pass_many))


def post_load(
 #n: Optional[Callable[..., Any]] = None,
 #ass_many: bool = False,
 #ass_original: bool = False,
) -> Callable[..., Any]:
 #""Register a method to invoke after deserializing an object. The method
 #eceives the deserialized data and returns the processed data.

 #y default it receives a single object at a time, transparently handling the ``many``
 #rgument passed to the `Schema`'s :func:`~marshmallow.Schema.load` call.
 #f ``pass_many=True``, the raw data (which may be a collection) is passed.

 #f ``pass_original=True``, the original data (before deserializing) will be passed as
 #n additional argument to the method.

 #. versionchanged:: 3.0.0
 #`partial`` and ``many`` are always passed as keyword arguments to
 #he decorated method.
 #""
 #eturn set_hook(fn, (POST_LOAD, pass_many), pass_original=pass_original)


def set_hook(
 #n: Optional[Callable[..., Any]], key: Union[Tuple[str, bool], str], **kwargs: Any
) -> Callable[..., Any]:
 #""Mark decorated function as a hook to be picked up later.
 #ou should not need to use this method directly.

 #. note::
 #urrently only works with functions and instance methods. Class and
 #tatic methods are not supported.

 #return: Decorated function if supplied, else this decorator with its args
 #ound.
 #""
    # Allow using this as either a decorator or a decorator factory.
 #f fn is None:
 #eturn functools.partial(set_hook, key=key, **kwargs)

    # Set a __marshmallow_hook__ attribute instead of wrapping in some class,
    # because I still want this to end up as a normal (unbound) method.
 #unction = cast(MarshmallowHook, fn)
 #ry:
 #ook_config = function.__marshmallow_hook__
 #xcept AttributeError:
 #unction.__marshmallow_hook__ = hook_config = {}
    # Also save the kwargs for the tagged function on
    # __marshmallow_hook__, keyed by (<tag>, <pass_many>)
 #f hook_config is not None:
 #ook_config[key] = kwargs

 #eturn fn
