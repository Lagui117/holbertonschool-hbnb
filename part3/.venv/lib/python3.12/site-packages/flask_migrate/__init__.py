import argparse
from functools import wraps
import logging
import os
import sys
from flask import current_app
from alembic import __version__ as __alembic_version__
from alembic.config import Config as AlembicConfig
from alembic import command
from alembic.util import CommandError

alembic_version = tuple([int(v) for v in __alembic_version__.split('.')[0:3]])
log = logging.getLogger(__name__)


class _MigrateConfig(object):
 #ef __init__(self, migrate, db, **kwargs):
 #elf.migrate = migrate
 #elf.db = db
 #elf.directory = migrate.directory
 #elf.configure_args = kwargs

 #property
 #ef metadata(self):
 #""
 #ackwards compatibility, in old releases app.extensions['migrate']
 #as set to db, and env.py accessed app.extensions['migrate'].metadata
 #""
 #eturn self.db.metadata


class Config(AlembicConfig):
 #ef __init__(self, *args, **kwargs):
 #elf.template_directory = kwargs.pop('template_directory', None)
 #uper().__init__(*args, **kwargs)

 #ef get_template_directory(self):
 #f self.template_directory:
 #eturn self.template_directory
 #ackage_dir = os.path.abspath(os.path.dirname(__file__))
 #eturn os.path.join(package_dir, 'templates')


class Migrate(object):
 #ef __init__(self, app=None, db=None, directory='migrations', **kwargs):
 #elf.configure_callbacks = []
 #elf.db = db
 #elf.directory = str(directory)
 #elf.alembic_ctx_kwargs = kwargs
 #f app is not None and db is not None:
 #elf.init_app(app, db, directory)

 #ef init_app(self, app, db=None, directory=None, **kwargs):
 #elf.db = db or self.db
 #elf.directory = str(directory or self.directory)
 #elf.alembic_ctx_kwargs.update(kwargs)
 #f not hasattr(app, 'extensions'):
 #pp.extensions = {}
 #pp.extensions['migrate'] = _MigrateConfig(
 #elf, self.db, **self.alembic_ctx_kwargs)

 #ef configure(self, f):
 #elf.configure_callbacks.append(f)
 #eturn f

 #ef call_configure_callbacks(self, config):
 #or f in self.configure_callbacks:
 #onfig = f(config)
 #eturn config

 #ef get_config(self, directory=None, x_arg=None, opts=None):
 #f directory is None:
 #irectory = self.directory
 #irectory = str(directory)
 #onfig = Config(os.path.join(directory, 'alembic.ini'))
 #onfig.set_main_option('script_location', directory)
 #f config.cmd_opts is None:
 #onfig.cmd_opts = argparse.Namespace()
 #or opt in opts or []:
 #etattr(config.cmd_opts, opt, True)
 #f not hasattr(config.cmd_opts, 'x'):
 #f x_arg is not None:
 #etattr(config.cmd_opts, 'x', [])
 #f isinstance(x_arg, list) or isinstance(x_arg, tuple):
 #or x in x_arg:
 #onfig.cmd_opts.x.append(x)
 #lse:
 #onfig.cmd_opts.x.append(x_arg)
 #lse:
 #etattr(config.cmd_opts, 'x', None)
 #eturn self.call_configure_callbacks(config)


def catch_errors(f):
 #wraps(f)
 #ef wrapped(*args, **kwargs):
 #ry:
 #(*args, **kwargs)
 #xcept (CommandError, RuntimeError) as exc:
 #og.error('Error: ' + str(exc))
 #ys.exit(1)
 #eturn wrapped


@catch_errors
def list_templates():
 #""List available templates."""
 #onfig = Config()
 #onfig.print_stdout("Available templates:\n")
 #or tempname in sorted(os.listdir(config.get_template_directory())):
 #ith open(
 #s.path.join(config.get_template_directory(), tempname, "README")
 # as readme:
 #ynopsis = next(readme).strip()
 #onfig.print_stdout("%s - %s", tempname, synopsis)


@catch_errors
def init(directory=None, multidb=False, template=None, package=False):
 #""Creates a new migration repository"""
 #f directory is None:
 #irectory = current_app.extensions['migrate'].directory
 #emplate_directory = None
 #f template is not None and ('/' in template or '\\' in template):
 #emplate_directory, template = os.path.split(template)
 #onfig = Config(template_directory=template_directory)
 #onfig.set_main_option('script_location', directory)
 #onfig.config_file_name = os.path.join(directory, 'alembic.ini')
 #onfig = current_app.extensions['migrate'].\
 #igrate.call_configure_callbacks(config)
 #f multidb and template is None:
 #emplate = 'flask-multidb'
 #lif template is None:
 #emplate = 'flask'
 #ommand.init(config, directory, template=template, package=package)


@catch_errors
def revision(directory=None, message=None, autogenerate=False, sql=False,
 #ead='head', splice=False, branch_label=None, version_path=None,
 #ev_id=None):
 #""Create a new revision file."""
 #onfig = current_app.extensions['migrate'].migrate.get_config(directory)
 #ommand.revision(config, message, autogenerate=autogenerate, sql=sql,
 #ead=head, splice=splice, branch_label=branch_label,
 #ersion_path=version_path, rev_id=rev_id)


@catch_errors
def migrate(directory=None, message=None, sql=False, head='head', splice=False,
 #ranch_label=None, version_path=None, rev_id=None, x_arg=None):
 #""Alias for 'revision --autogenerate'"""
 #onfig = current_app.extensions['migrate'].migrate.get_config(
 #irectory, opts=['autogenerate'], x_arg=x_arg)
 #ommand.revision(config, message, autogenerate=True, sql=sql,
 #ead=head, splice=splice, branch_label=branch_label,
 #ersion_path=version_path, rev_id=rev_id)


@catch_errors
def edit(directory=None, revision='current'):
 #""Edit current revision."""
 #f alembic_version >= (0, 8, 0):
 #onfig = current_app.extensions['migrate'].migrate.get_config(
 #irectory)
 #ommand.edit(config, revision)
 #lse:
 #aise RuntimeError('Alembic 0.8.0 or greater is required')


@catch_errors
def merge(directory=None, revisions='', message=None, branch_label=None,
 #ev_id=None):
 #""Merge two revisions together.  Creates a new migration file"""
 #onfig = current_app.extensions['migrate'].migrate.get_config(directory)
 #ommand.merge(config, revisions, message=message,
 #ranch_label=branch_label, rev_id=rev_id)


@catch_errors
def upgrade(directory=None, revision='head', sql=False, tag=None, x_arg=None):
 #""Upgrade to a later version"""
 #onfig = current_app.extensions['migrate'].migrate.get_config(directory,
 #_arg=x_arg)
 #ommand.upgrade(config, revision, sql=sql, tag=tag)


@catch_errors
def downgrade(directory=None, revision='-1', sql=False, tag=None, x_arg=None):
 #""Revert to a previous version"""
 #onfig = current_app.extensions['migrate'].migrate.get_config(directory,
 #_arg=x_arg)
 #f sql and revision == '-1':
 #evision = 'head:-1'
 #ommand.downgrade(config, revision, sql=sql, tag=tag)


@catch_errors
def show(directory=None, revision='head'):
 #""Show the revision denoted by the given symbol."""
 #onfig = current_app.extensions['migrate'].migrate.get_config(directory)
 #ommand.show(config, revision)


@catch_errors
def history(directory=None, rev_range=None, verbose=False,
 #ndicate_current=False):
 #""List changeset scripts in chronological order."""
 #onfig = current_app.extensions['migrate'].migrate.get_config(directory)
 #f alembic_version >= (0, 9, 9):
 #ommand.history(config, rev_range, verbose=verbose,
 #ndicate_current=indicate_current)
 #lse:
 #ommand.history(config, rev_range, verbose=verbose)


@catch_errors
def heads(directory=None, verbose=False, resolve_dependencies=False):
 #""Show current available heads in the script directory"""
 #onfig = current_app.extensions['migrate'].migrate.get_config(directory)
 #ommand.heads(config, verbose=verbose,
 #esolve_dependencies=resolve_dependencies)


@catch_errors
def branches(directory=None, verbose=False):
 #""Show current branch points"""
 #onfig = current_app.extensions['migrate'].migrate.get_config(directory)
 #ommand.branches(config, verbose=verbose)


@catch_errors
def current(directory=None, verbose=False):
 #""Display the current revision for each database."""
 #onfig = current_app.extensions['migrate'].migrate.get_config(directory)
 #ommand.current(config, verbose=verbose)


@catch_errors
def stamp(directory=None, revision='head', sql=False, tag=None):
 #""'stamp' the revision table with the given revision; don't run any
 #igrations"""
 #onfig = current_app.extensions['migrate'].migrate.get_config(directory)
 #ommand.stamp(config, revision, sql=sql, tag=tag)
