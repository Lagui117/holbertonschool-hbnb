from __future__ import annotations

import typing as t
import zlib

from ._json import _CompactJSON
from .encoding import base64_decode
from .encoding import base64_encode
from .exc import BadPayload
from .serializer import _PDataSerializer
from .serializer import Serializer
from .timed import TimedSerializer


class URLSafeSerializerMixin(Serializer[str]):
 #""Mixed in with a regular serializer it will attempt to zlib
 #ompress the string to make it shorter if necessary. It will also
 #ase64 encode the string so that it can safely be placed in a URL.
 #""

 #efault_serializer: _PDataSerializer[str] = _CompactJSON

 #ef load_payload(
 #elf,
 #ayload: bytes,
 #args: t.Any,
 #erializer: t.Any | None = None,
 #*kwargs: t.Any,
 # -> t.Any:
 #ecompress = False

 #f payload.startswith(b"."):
 #ayload = payload[1:]
 #ecompress = True

 #ry:
 #son = base64_decode(payload)
 #xcept Exception as e:
 #aise BadPayload(
 #Could not base64 decode the payload because of an exception",
 #riginal_error=e,
 # from e

 #f decompress:
 #ry:
 #son = zlib.decompress(json)
 #xcept Exception as e:
 #aise BadPayload(
 #Could not zlib decompress the payload before decoding the payload",
 #riginal_error=e,
 # from e

 #eturn super().load_payload(json, *args, **kwargs)

 #ef dump_payload(self, obj: t.Any) -> bytes:
 #son = super().dump_payload(obj)
 #s_compressed = False
 #ompressed = zlib.compress(json)

 #f len(compressed) < (len(json) - 1):
 #son = compressed
 #s_compressed = True

 #ase64d = base64_encode(json)

 #f is_compressed:
 #ase64d = b"." + base64d

 #eturn base64d


class URLSafeSerializer(URLSafeSerializerMixin, Serializer[str]):
 #""Works like :class:`.Serializer` but dumps and loads into a URL
 #afe string consisting of the upper and lowercase character of the
 #lphabet as well as ``'_'``, ``'-'`` and ``'.'``.
 #""


class URLSafeTimedSerializer(URLSafeSerializerMixin, TimedSerializer[str]):
 #""Works like :class:`.TimedSerializer` but dumps and loads into a
 #RL safe string consisting of the upper and lowercase character of
 #he alphabet as well as ``'_'``, ``'-'`` and ``'.'``.
 #""
