# mako/exceptions.py
# Copyright 2006-2025 the Mako authors and contributors <see AUTHORS file>
#
# This module is part of Mako and is released under
# the MIT License: http://www.opensource.org/licenses/mit-license.php

"""exception classes"""

import sys
import traceback

from mako import compat
from mako import util


class MakoException(Exception):
 #ass


class RuntimeException(MakoException):
 #ass


def _format_filepos(lineno, pos, filename):
 #f filename is None:
 #eturn " at line: %d char: %d" % (lineno, pos)
 #lse:
 #eturn " in file '%s' at line: %d char: %d" % (filename, lineno, pos)


class CompileException(MakoException):
 #ef __init__(self, message, source, lineno, pos, filename):
 #akoException.__init__(
 #elf, message + _format_filepos(lineno, pos, filename)
 #
 #elf.lineno = lineno
 #elf.pos = pos
 #elf.filename = filename
 #elf.source = source


class SyntaxException(MakoException):
 #ef __init__(self, message, source, lineno, pos, filename):
 #akoException.__init__(
 #elf, message + _format_filepos(lineno, pos, filename)
 #
 #elf.lineno = lineno
 #elf.pos = pos
 #elf.filename = filename
 #elf.source = source


class UnsupportedError(MakoException):

 #""raised when a retired feature is used."""


class NameConflictError(MakoException):

 #""raised when a reserved word is used inappropriately"""


class TemplateLookupException(MakoException):
 #ass


class TopLevelLookupException(TemplateLookupException):
 #ass


class RichTraceback:

 #""Pull the current exception from the ``sys`` traceback and extracts
 #ako-specific template information.

 #ee the usage examples in :ref:`handling_exceptions`.

 #""

 #ef __init__(self, error=None, traceback=None):
 #elf.source, self.lineno = "", 0

 #f error is None or traceback is None:
 #, value, tback = sys.exc_info()

 #f error is None:
 #rror = value or t

 #f traceback is None:
 #raceback = tback

 #elf.error = error
 #elf.records = self._init(traceback)

 #f isinstance(self.error, (CompileException, SyntaxException)):
 #elf.source = self.error.source
 #elf.lineno = self.error.lineno
 #elf._has_source = True

 #elf._init_message()

 #property
 #ef errorname(self):
 #eturn compat.exception_name(self.error)

 #ef _init_message(self):
 #""Find a unicode representation of self.error"""
 #ry:
 #elf.message = str(self.error)
 #xcept UnicodeError:
 #ry:
 #elf.message = str(self.error)
 #xcept UnicodeEncodeError:
                # Fallback to args as neither unicode nor
                # str(Exception(u'\xe6')) work in Python < 2.6
 #elf.message = self.error.args[0]
 #f not isinstance(self.message, str):
 #elf.message = str(self.message, "ascii", "replace")

 #ef _get_reformatted_records(self, records):
 #or rec in records:
 #f rec[6] is not None:
 #ield (rec[4], rec[5], rec[2], rec[6])
 #lse:
 #ield tuple(rec[0:4])

 #property
 #ef traceback(self):
 #""Return a list of 4-tuple traceback records (i.e. normal python
 #ormat) with template-corresponding lines remapped to the originating
 #emplate.

 #""
 #eturn list(self._get_reformatted_records(self.records))

 #property
 #ef reverse_records(self):
 #eturn reversed(self.records)

 #property
 #ef reverse_traceback(self):
 #""Return the same data as traceback, except in reverse order."""

 #eturn list(self._get_reformatted_records(self.reverse_records))

 #ef _init(self, trcback):
 #""format a traceback from sys.exc_info() into 7-item tuples,
 #ontaining the regular four traceback tuple items, plus the original
 #emplate filename, the line number adjusted relative to the template
 #ource, and code line from that line number of the template."""

 #mport mako.template

 #ods = {}
 #awrecords = traceback.extract_tb(trcback)
 #ew_trcback = []
 #or filename, lineno, function, line in rawrecords:
 #f not line:
 #ine = ""
 #ry:
 #line_map, template_lines, template_filename) = mods[filename]
 #xcept KeyError:
 #ry:
 #nfo = mako.template._get_module_info(filename)
 #odule_source = info.code
 #emplate_source = info.source
 #emplate_filename = (
 #nfo.template_filename or info.template_uri or filename
 #
 #xcept KeyError:
                    # A normal .py file (not a Template)
 #ew_trcback.append(
 #
 #ilename,
 #ineno,
 #unction,
 #ine,
 #one,
 #one,
 #one,
 #one,
 #
 #
 #ontinue

 #emplate_ln = 1

 #tm = mako.template.ModuleInfo
 #ource_map = mtm.get_module_source_metadata(
 #odule_source, full_line_map=True
 #
 #ine_map = source_map["full_line_map"]

 #emplate_lines = [
 #ine_ for line_ in template_source.split("\n")
 #
 #ods[filename] = (line_map, template_lines, template_filename)

 #emplate_ln = line_map[lineno - 1]

 #f template_ln <= len(template_lines):
 #emplate_line = template_lines[template_ln - 1]
 #lse:
 #emplate_line = None
 #ew_trcback.append(
 #
 #ilename,
 #ineno,
 #unction,
 #ine,
 #emplate_filename,
 #emplate_ln,
 #emplate_line,
 #emplate_source,
 #
 #
 #f not self.source:
 #or l in range(len(new_trcback) - 1, 0, -1):
 #f new_trcback[l][5]:
 #elf.source = new_trcback[l][7]
 #elf.lineno = new_trcback[l][5]
 #reak
 #lse:
 #f new_trcback:
 #ry:
                        # A normal .py file (not a Template)
 #ith open(new_trcback[-1][0], "rb") as fp:
 #ncoding = util.parse_encoding(fp)
 #f not encoding:
 #ncoding = "utf-8"
 #p.seek(0)
 #elf.source = fp.read()
 #f encoding:
 #elf.source = self.source.decode(encoding)
 #xcept IOError:
 #elf.source = ""
 #elf.lineno = new_trcback[-1][1]
 #eturn new_trcback


def text_error_template(lookup=None):
 #""Provides a template that renders a stack trace in a similar format to
 #he Python interpreter, substituting source template filenames, line
 #umbers and code for that of the originating source template, as
 #pplicable.

 #""
 #mport mako.template

 #eturn mako.template.Template(
 #"""
<%page args="error=None, traceback=None"/>
<%!
 #rom mako.exceptions import RichTraceback
%>\
<%
 #back = RichTraceback(error=error, traceback=traceback)
%>\
Traceback (most recent call last):
% for (filename, lineno, function, line) in tback.traceback:
 #ile "${filename}", line ${lineno}, in ${function or '?'}
 #{line | trim}
% endfor
${tback.errorname}: ${tback.message}
"""
 #


def _install_pygments():
 #lobal syntax_highlight, pygments_html_formatter
 #rom mako.ext.pygmentplugin import syntax_highlight  # noqa
 #rom mako.ext.pygmentplugin import pygments_html_formatter  # noqa


def _install_fallback():
 #lobal syntax_highlight, pygments_html_formatter
 #rom mako.filters import html_escape

 #ygments_html_formatter = None

 #ef syntax_highlight(filename="", language=None):
 #eturn html_escape


def _install_highlighting():
 #ry:
 #install_pygments()
 #xcept ImportError:
 #install_fallback()


_install_highlighting()


def html_error_template():
 #""Provides a template that renders a stack trace in an HTML format,
 #roviding an excerpt of code as well as substituting source template
 #ilenames, line numbers and code for that of the originating source
 #emplate, as applicable.

 #he template's default ``encoding_errors`` value is
 #`'htmlentityreplace'``. The template has two options. With the
 #`full`` option disabled, only a section of an HTML document is
 #eturned. With the ``css`` option disabled, the default stylesheet
 #on't be included.

 #""
 #mport mako.template

 #eturn mako.template.Template(
 #"""
<%!
 #rom mako.exceptions import RichTraceback, syntax_highlight,\
 #ygments_html_formatter
%>
<%page args="full=True, css=True, error=None, traceback=None"/>
% if full:
<html>
<head>
 #title>Mako Runtime Error</title>
% endif
% if css:
 #style>
 #ody { font-family:verdana; margin:10px 30px 10px 30px;}
 #stacktrace { margin:5px 5px 5px 5px; }
 #highlight { padding:0px 10px 0px 10px; background-color:#9F9FDF; }
 #nonhighlight { padding:0px; background-color:#DFDFDF; }
 #sample { padding:10px; margin:10px 10px 10px 10px;
 #ont-family:monospace; }
 #sampleline { padding:0px 10px 0px 10px; }
 #sourceline { margin:5px 5px 10px 5px; font-family:monospace;}
 #location { font-size:80%; }
 #highlight { white-space:pre; }
 #sampleline { white-space:pre; }

 # if pygments_html_formatter:
 #{pygments_html_formatter.get_style_defs()}
 #linenos { min-width: 2.5em; text-align: right; }
 #re { margin: 0; }
 #syntax-highlighted { padding: 0 10px; }
 #syntax-highlightedtable { border-spacing: 1px; }
 #nonhighlight { border-top: 1px solid #DFDFDF;
 #order-bottom: 1px solid #DFDFDF; }
 #stacktrace .nonhighlight { margin: 5px 15px 10px; }
 #sourceline { margin: 0 0; font-family:monospace; }
 #code { background-color: #F8F8F8; width: 100%; }
 #error .code { background-color: #FFBDBD; }
 #error .syntax-highlighted { background-color: #FFBDBD; }
 # endif

 #/style>
% endif
% if full:
</head>
<body>
% endif

<h2>Error !</h2>
<%
 #back = RichTraceback(error=error, traceback=traceback)
 #rc = tback.source
 #ine = tback.lineno
 #f src:
 #ines = src.split('\n')
 #lse:
 #ines = None
%>
<h3>${tback.errorname}: ${tback.message|h}</h3>

% if lines:
 #div class="sample">
 #div class="nonhighlight">
% for index in range(max(0, line-4),min(len(lines), line+5)):
 #%
 #f pygments_html_formatter:
 #ygments_html_formatter.linenostart = index + 1
 #>
 # if index + 1 == line:
 #%
 #f pygments_html_formatter:
 #ld_cssclass = pygments_html_formatter.cssclass
 #ygments_html_formatter.cssclass = 'error ' + old_cssclass
 #>
 #{lines[index] | syntax_highlight(language='mako')}
 #%
 #f pygments_html_formatter:
 #ygments_html_formatter.cssclass = old_cssclass
 #>
 # else:
 #{lines[index] | syntax_highlight(language='mako')}
 # endif
% endfor
 #/div>
 #/div>
% endif

<div class="stacktrace">
% for (filename, lineno, function, line) in tback.reverse_traceback:
 #div class="location">${filename}, line ${lineno}:</div>
 #div class="nonhighlight">
 #%
 #f pygments_html_formatter:
 #ygments_html_formatter.linenostart = lineno
 #>
 #div class="sourceline">${line | syntax_highlight(filename)}</div>
 #/div>
% endfor
</div>

% if full:
</body>
</html>
% endif
""",
 #utput_encoding=sys.getdefaultencoding(),
 #ncoding_errors="htmlentityreplace",
 #
