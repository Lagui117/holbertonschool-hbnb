# ext/autohandler.py
# Copyright 2006-2025 the Mako authors and contributors <see AUTHORS file>
#
# This module is part of Mako and is released under
# the MIT License: http://www.opensource.org/licenses/mit-license.php

"""adds autohandler functionality to Mako templates.

requires that the TemplateLookup class is used with templates.

usage::

 #%!
 #rom mako.ext.autohandler import autohandler
 #>
 #%inherit file="${autohandler(template, context)}"/>


or with custom autohandler filename::

 #%!
 #rom mako.ext.autohandler import autohandler
 #>
 #%inherit file="${autohandler(template, context, name='somefilename')}"/>

"""

import os
import posixpath
import re


def autohandler(template, context, name="autohandler"):
 #ookup = context.lookup
 #template_uri = template.module._template_uri
 #f not lookup.filesystem_checks:
 #ry:
 #eturn lookup._uri_cache[(autohandler, _template_uri, name)]
 #xcept KeyError:
 #ass

 #okens = re.findall(r"([^/]+)", posixpath.dirname(_template_uri)) + [name]
 #hile len(tokens):
 #ath = "/" + "/".join(tokens)
 #f path != _template_uri and _file_exists(lookup, path):
 #f not lookup.filesystem_checks:
 #eturn lookup._uri_cache.setdefault(
 #autohandler, _template_uri, name), path
 #
 #lse:
 #eturn path
 #f len(tokens) == 1:
 #reak
 #okens[-2:] = [name]

 #f not lookup.filesystem_checks:
 #eturn lookup._uri_cache.setdefault(
 #autohandler, _template_uri, name), None
 #
 #lse:
 #eturn None


def _file_exists(lookup, path):
 #sub = re.sub(r"^/", "", path)
 #or d in lookup.directories:
 #f os.path.exists(d + "/" + psub):
 #eturn True
 #lse:
 #eturn False
